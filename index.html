<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNEA Assessment | Professional Engineering Admissions Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #7c3aed;
            --success: #16a34a;
            --danger: #dc2626;

            /* Light Theme Colors */
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .nav-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            :root {
                --hero-padding: 4rem 0 2rem;
                --section-padding: 3rem 0;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        /* Utility */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .gradient-text {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Header / Navbar */
        .navbar {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text);
        }

        .logo-icon {
            background: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            line-height: 1.2;
        }

        .logo-network {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.02em;
        }

        .logo-sub {
            font-size: 0.75rem;
            color: var(--primary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            z-index: 1001;
        }

        @media (max-width: 1024px) {
            .nav-links {
                gap: 0.5rem;
            }

            .nav-link {
                font-size: 0.8rem;
                padding: 0.4rem;
            }
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .nav-links {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background: var(--surface);
                flex-direction: column;
                padding: 5rem 2rem 2rem;
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
                transition: right 0.3s ease;
                z-index: 1000;
                margin-left: 0;
                flex-wrap: nowrap;
            }

            .nav-links.active {
                right: 0;
            }

            .nav-link {
                font-size: 1.1rem;
                padding: 1rem 0;
                border-bottom: 1px solid var(--border);
                width: 100%;
            }
        }

        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 0.5rem;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--text);
        }

        /* Hero Section */
        .hero {
            padding: 6rem 0 4rem;
            text-align: center;
            background: radial-gradient(circle at top center, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 700px;
            margin: 0 auto 3rem;
        }

        @media (max-width: 768px) {
            .hero {
                padding: 4rem 0 2rem;
            }

            .hero-title {
                font-size: 2.25rem;
            }

            .hero-subtitle {
                font-size: 1rem;
                margin-bottom: 2rem;
            }

            .container {
                padding: 0 1.25rem;
            }
        }

        .hero-greeting {
            display: inline-block;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            padding: 0.5rem 1.25rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(37, 99, 235, 0.2);
            backdrop-filter: blur(4px);
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .stat-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Top Colleges List */
        .top-list-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .top-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .top-list-item:last-child {
            border-bottom: none;
        }

        .college-rank-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rank-badge {
            width: 28px;
            height: 28px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Section Styles */
        .section-container {
            padding: 2rem 0 4rem;
        }

        /* Hide sections by default */
        .app-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .app-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        /* Steps Grid */
        .steps-wrapper {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border);
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .step-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .step-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        /* Chat Bot */
        .chatbot-btn {
            position: fixed;
            top: 120px;
            /* Below navbar */
            left: 20px;
            padding: 0 1.5rem;
            height: 60px;
            background: var(--primary);
            border-radius: 30px;
            /* Pill shape */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            cursor: pointer;
            z-index: 999;
            transition: transform 0.2s;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .chatbot-btn:hover {
            transform: scale(1.05);
            background: var(--primary-dark);
        }

        .chatbot-window {
            position: fixed;
            top: 190px;
            /* Below button */
            left: 20px;
            width: 350px;
            height: 500px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
        }

        .chatbot-window.open {
            display: flex;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .chatbot-btn {
                top: auto;
                bottom: 20px;
                left: auto;
                right: 20px;
                height: 50px;
                padding: 0 1rem;
                font-size: 0.9rem;
            }

            .chatbot-window {
                top: auto;
                bottom: 80px;
                left: 5%;
                width: 90%;
                height: 70vh;
            }
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--background);
        }

        .chat-input-area {
            padding: 1rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
        }

        .chat-chip {
            padding: 0.35rem 0.75rem;
            background: rgba(37, 99, 235, 0.08);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 15px;
            font-size: 0.75rem;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .chat-chip:hover {
            background: var(--primary);
            color: white;
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            align-self: flex-start;
            font-style: italic;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 50%;
            margin-right: 2px;
            animation: typing 1s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--background);
            color: var(--text);
            outline: none;
        }

        .chat-send {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .message.bot {
            background: var(--surface);
            color: var(--text);
            border-radius: 12px 12px 12px 0;
            border: 1px solid var(--border);
        }

        .message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-radius: 12px 12px 0 12px;
        }

        /* --- Existing Components --- */

        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        .filter-select,
        .filter-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(241, 245, 249, 1);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            position: sticky;
            top: 0;
        }

        @media (max-width: 768px) {

            th,
            td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }

            .branch-code {
                font-size: 0.7rem;
                padding: 0.15rem 0.35rem;
            }
        }

        tr:hover {
            background: var(--surface-hover);
        }

        .branch-code {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .cutoff-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .cutoff-value.high {
            color: var(--success);
        }

        .cutoff-value.medium {
            color: var(--accent);
        }

        .cutoff-value.low {
            color: var(--danger);
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* Course Cards */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .course-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
        }

        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Course Info Modal */
        .course-modal {
            max-width: 600px;
            width: 90%;
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalIn 0.3s ease-out;
        }

        .modal-info-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-info-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .info-section {
            margin-bottom: 1.5rem;
        }

        .info-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
        }

        .info-content {
            font-size: 0.95rem;
            color: var(--text);
            line-height: 1.6;
        }

        .feature-list {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .feature-item {
            background: rgba(37, 99, 235, 0.05);
            color: var(--primary);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(37, 99, 235, 0.1);
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .course-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .course-card p {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .tag {
            background: var(--background);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            display: inline-block;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            border: 1px solid var(--border);
        }

        /* Loading */
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Quiz Styles */
        .quiz-option {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .quiz-option:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.03);
            transform: translateX(8px);
        }

        .quiz-option h5 {
            margin-bottom: 0.25rem;
            color: var(--text);
            font-size: 1rem;
        }

        .quiz-option p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        .quiz-progress-container {
            background: var(--surface-hover);
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        /* Course Comparison Module Styles */
        .compare-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2.5rem;
            background: var(--surface);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .compare-toggle-btn {
            padding: 0.75rem 2rem;
            border: none;
            background: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .compare-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .branch-comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .branch-comparison-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .branch-compare-card {
                padding: 1.5rem;
            }
        }

        .branch-compare-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .branch-compare-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .compare-v-badge {
            position: absolute;
            top: 50%;
            left: -1rem;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.8rem;
            border: 4px solid var(--background);
            z-index: 10;
        }

        .comparison-metric-row {
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .comparison-metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.35rem;
            display: block;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
        }

        .decision-helper-box {
            margin-top: 3rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            padding: 2.5rem;
            border-radius: 20px;
            border: 1px dashed var(--primary);
            position: relative;
            overflow: hidden;
        }

        .decision-helper-box::before {
            content: "ðŸ’¡";
            position: absolute;
            top: -1rem;
            right: -1rem;
            font-size: 6rem;
            opacity: 0.1;
        }

        .advisor-card {
            background: rgba(37, 99, 235, 0.04);
            border: 1px solid rgba(37, 99, 235, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
            text-align: left;
            margin-bottom: 2rem;
            animation: slideUp 0.4s ease-out;
        }

        .advisor-avatar-container {
            flex-shrink: 0;
        }

        .advisor-avatar {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--primary);
        }

        .advisor-content {
            flex: 1;
        }

        .advisor-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .advisor-greeting {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--text);
        }

        .advisor-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-muted);
            margin: 0;
        }

        .advisor-text strong {
            color: var(--primary);
        }

        .roi-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* --- Premium CTA Section --- */
        .premium-cta {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            padding: 6rem 0;
            text-align: center;
            border-top: 1px solid var(--border);
        }

        .cta-closing-line {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            color: var(--text);
        }

        .cta-subline {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 3rem;
        }

        /* --- Premium Footer --- */
        .footer {
            background: #0f172a;
            color: #94a3b8;
            padding: 5rem 0 3rem;
            border-top: 1px solid #1e293b;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 4rem;
            margin-bottom: 4rem;
        }

        @media (max-width: 1024px) {
            .footer-grid {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }

        @media (max-width: 640px) {
            .footer-grid {
                grid-template-columns: 1fr;
                gap: 2.5rem;
            }

            .footer-brand {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .footer-tagline {
                max-width: 100%;
            }

            .footer-bottom {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }
        }

        .footer-brand .logo-icon {
            background: #3b82f6;
            margin-bottom: 1.5rem;
        }

        .footer-brand .logo-network {
            color: #f8fafc;
            font-size: 1.5rem;
        }

        .footer-tagline {
            margin-top: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            max-width: 300px;
        }

        .footer-heading {
            color: #f8fafc;
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.75rem;
        }

        .footer-link {
            color: inherit;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
            cursor: pointer;
        }

        .footer-link:hover {
            color: #3b82f6;
        }

        .footer-bottom {
            padding-top: 2rem;
            border-top: 1px solid #1e293b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .social-links {
            display: flex;
            gap: 1rem;
        }

        .social-icon {
            width: 36px;
            height: 36px;
            background: #1e293b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f8fafc;
            text-decoration: none;
            transition: all 0.2s;
        }

        .social-icon:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }

        /* Legal Modal Content */
        .legal-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 1rem;
            text-align: left;
        }

        .legal-content h3 {
            margin: 1.5rem 0 0.75rem;
            font-size: 1.1rem;
            color: var(--text);
        }

        .legal-content p {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .legal-content ul {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .legal-content li {
            margin-bottom: 0.5rem;
        }

        /* ===== College Predictor Styles ===== */
        .predictor-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .predictor-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .predictor-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }

        .predictor-progress .progress-fill {
            position: absolute;
            top: 20px;
            left: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            z-index: 1;
            transition: width 0.5s ease;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            cursor: default;
        }

        .progress-step .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s;
            color: var(--text-muted);
        }

        .progress-step.active .step-circle {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .progress-step.completed .step-circle {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .progress-step .step-label {
            margin-top: 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .progress-step.active .step-label {
            color: var(--primary);
        }

        .progress-step.completed .step-label {
            color: var(--success);
        }

        .predictor-step {
            display: none;
            animation: fadeSlide 0.4s ease;
        }

        .predictor-step.active {
            display: block;
        }

        @keyframes fadeSlide {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .form-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .form-card .form-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .cutoff-display {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin: 1.5rem 0;
        }

        .cutoff-display .cutoff-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
        }

        .cutoff-display .cutoff-score {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cutoff-display .cutoff-formula {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .btn-primary {
            padding: 0.85rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            padding: 0.85rem 2rem;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .preference-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .preference-chip {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--background);
            color: var(--text-muted);
        }

        .preference-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .preference-chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Results */
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .result-stat .result-num {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .result-stat .result-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .suggestion-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .suggestion-card:hover {
            transform: translateX(4px);
            box-shadow: -4px 0 0 var(--primary);
        }

        .suggestion-card .suggestion-info {
            flex: 1;
        }

        .suggestion-card .college-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }

        .suggestion-card .branch-name {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .suggestion-card .suggestion-meta {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }

        .meta-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }

        .meta-badge.cutoff-badge {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .meta-badge.rank-badge-tag {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .tier-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .tier-label.dream {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .tier-label.reach {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .tier-label.safe {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .results-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .no-results-msg {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .no-results-msg .emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* ===== Login Modal Styles ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .login-modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            width: 420px;
            max-width: 90vw;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            animation: modalSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-modal .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-modal .modal-header .modal-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .login-modal .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }

        .login-modal .modal-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .login-modal .form-group {
            margin-bottom: 1.2rem;
        }

        .login-modal .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .login-modal .form-group input {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .login-modal .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .login-modal .login-btn {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 0.5rem;
        }

        .login-modal .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .login-modal .toggle-mode {
            text-align: center;
            margin-top: 1.2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .login-modal .toggle-mode a {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .login-modal .toggle-mode a:hover {
            text-decoration: underline;
        }

        .login-modal .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            padding: 0.7rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }

        .login-modal .guest-link a {
            color: var(--text-muted);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Auth Enhancements Styles */
        .login-google-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 0.85rem;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .login-google-btn:hover {
            background: #f8f9fa;
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        .auth-separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin: 1.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .auth-separator::before,
        .auth-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border);
        }

        .auth-separator:not(:empty)::before {
            margin-right: 1rem;
        }

        .auth-separator:not(:empty)::after {
            margin-left: 1rem;
        }

        .forgot-link-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-top: -0.8rem;
            margin-bottom: 1.2rem;
        }

        .forgot-password-link {
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        /* User Area in Navbar */
        .user-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: 1rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .logout-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }

        .login-nav-btn {
            padding: 0.5rem 1.2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.2s;
            margin-left: 1rem;
        }

        .login-nav-btn:hover {
            transform: scale(1.05);
        }

        /* Favorite Button */
        .fav-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 0.2rem;
            opacity: 0.5;
        }

        .fav-btn:hover {
            transform: scale(1.3);
            opacity: 1;
        }

        .fav-btn.saved {
            opacity: 1;
        }

        /* Favorites Section */
        .fav-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s;
        }

        .fav-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
        }

        .fav-card .fav-info {
            flex: 1;
        }

        .fav-card .fav-college {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
        }

        .fav-card .fav-branch {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .fav-card .fav-cutoffs {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .fav-card .fav-cutoff-tag {
            padding: 0.2rem 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary);
        }

        .remove-fav-btn {
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .remove-fav-btn:hover {
            background: var(--danger);
            color: white;
        }

        .fav-empty {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .fav-empty .fav-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .fav-count-badge {
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.3rem;
            min-width: 16px;
            text-align: center;
            display: inline-block;
        }

        /* Assessment Styles */
        .assessment-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .assessment-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Assessment Navigation */
        .assessment-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .back-nav-container {
            display: none;
            /* Hidden by default, shown when needed */
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
            font-size: 0.9rem;
        }

        .back-btn:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        /* Goal Selection */
        .goal-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .goal-item {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .goal-item:hover {
            border-color: var(--primary);
            background: var(--surface);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .goal-item.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .goal-item-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .goal-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        /* Guidance Styles */
        .guidance-section {
            margin-top: 2rem;
            text-align: left;
            animation: fadeIn 0.5s ease-out;
        }

        .guidance-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .guidance-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .tip-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.5;
        }

        .tip-bullet {
            color: var(--primary);
            font-weight: bold;
        }

        .related-courses-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .related-course-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
        }

        .related-course-card:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .related-course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .related-course-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
        }

        .related-why-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border-radius: 4px;
            font-weight: 600;
        }

        .related-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .recommendation-result {
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .result-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .result-desc {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            line-height: 1.6;
        }

        .recommendation-tags {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .mode-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .mode-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .mode-card .mode-icon {
            font-size: 3rem;
        }

        .mode-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .mode-card p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .branch-chips-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .branch-chip-input {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 99px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .branch-chip-input.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .comparison-breakdown {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 2rem;
            text-align: left;
        }

        .breakdown-item {
            margin-bottom: 1.5rem;
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .breakdown-label {
            font-weight: 700;
            font-size: 1rem;
        }

        .breakdown-percentage {
            font-weight: 800;
            color: var(--primary);
        }

        .breakdown-bar-bg {
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .breakdown-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.6s ease;
        }

        /* Career Advisor Persona */
        .advisor-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            display: flex;
            gap: 2rem;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            position: relative;
            overflow: hidden;
        }

        .advisor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .advisor-avatar-container {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            background: var(--surface);
            border-radius: 50%;
            padding: 5px;
            border: 3px solid var(--primary);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2);
        }

        .advisor-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #eef2ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .advisor-content h4 {
            color: var(--primary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .advisor-greeting {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .advisor-text {
            color: var(--text-muted);
            line-height: 1.7;
            font-size: 1.05rem;
        }

        .course-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .detail-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .detail-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .detailed-info-panel {
            display: none;
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            font-size: 0.95rem;
            border-left: 4px solid var(--primary);
            line-height: 1.6;
            color: var(--text-muted);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-card h5 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .detail-icon {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .detail-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .balance-section {
            margin: 2.5rem 0;
            padding: 2.5rem;
            background: white;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2.5rem;
            margin-top: 2rem;
        }

        .balance-column h6 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 800;
        }

        .pros-title {
            color: var(--success);
        }

        .cons-title {
            color: #e11d48;
        }

        .balance-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .balance-list li {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: start;
            color: #475569;
            line-height: 1.5;
        }

        .balance-list li::before {
            content: '';
            font-size: 1.5rem;
            line-height: 1;
        }

        .pros-list li::before {
            color: var(--success);
        }

        .cons-list li::before {
            color: #e11d48;
        }


        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(37, 99, 235, 0.1);
            transform: translateX(-5px);
        }

        .course-meta-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px dashed var(--border);
        }

        .course-meta-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .course-meta-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .detail-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* Career Advisor Persona */
        .advisor-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            display: flex;
            gap: 2rem;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            position: relative;
            overflow: hidden;
        }

        .advisor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .advisor-avatar-container {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            background: var(--surface);
            border-radius: 50%;
            padding: 5px;
            border: 3px solid var(--primary);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2);
        }

        .advisor-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #eef2ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .advisor-content h4 {
            color: var(--primary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .advisor-greeting {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .advisor-text {
            color: var(--text-muted);
            line-height: 1.7;
            font-size: 1.05rem;
        }

        .course-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .detail-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .detail-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .detail-card h5 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .detail-icon {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .detail-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .academic-group-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .academic-group-btn {
            padding: 1rem 2rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            flex: 1;
            max-width: 200px;
        }

        .academic-group-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
            color: var(--primary);
        }

        .mark-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            text-align: left;
            margin-bottom: 2rem;
        }

        .mark-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .mark-field input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface);
            color: var(--text);
        }

        .reasoning-box {
            background: rgba(37, 99, 235, 0.05);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 0 12px 12px 0;
            margin: 2rem 0;
            text-align: left;
        }

        .reasoning-header {
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
        }
    </style>
</head>

<body>

    <header class="navbar">
        <div class="container nav-content">
            <a href="#" class="logo" onclick="switchTab('dashboard')">
                <div class="logo-icon">ðŸŽ“</div>
                <div class="logo-text">
                    <div class="logo-network">TNEA</div>
                    <div class="logo-sub">Assessment</div>
                </div>
            </a>
            <button class="menu-toggle" id="menuToggle" aria-label="Toggle Menu">â˜°</button>
            <div class="nav-overlay" id="navOverlay"></div>
            <nav class="nav-links" id="navLinks">
                <button class="nav-link" data-tab="assessment" onclick="switchTab('assessment')">Assessment</button>
                <button class="nav-link" data-tab="predictor" onclick="switchTab('predictor')">Predictor</button>
                <button class="nav-link" data-tab="cutoff-search" onclick="switchTab('cutoff-search')">Cutoffs</button>
                <button class="nav-link" data-tab="courses" onclick="switchTab('courses')">Insights</button>
                <button class="nav-link" data-tab="rankings" onclick="switchTab('rankings')">Rankings</button>
                <button class="nav-link" data-tab="compare" onclick="switchTab('compare')">Compare</button>
                <button class="nav-link" data-tab="favorites" onclick="switchTab('favorites')">Favorites <span
                        class="fav-count-badge" id="favCountBadge" style="display:none">0</span></button>
            </nav>
            <div id="userArea">
                <!-- Populated by JS: either login button or user info -->
            </div>
        </div>
    </header>

    <main>
        <!-- Home / Dashboard Section -->
        <section id="dashboard" class="app-section active">
            <div class="hero">
                <div class="container">
                    <div id="heroGreetingContainer"></div>
                    <h1 class="hero-title">
                        Turn Your TNEA Marks into <br>
                        <span class="gradient-text">Smart Career Decisions</span>
                    </h1>
                    <div style="margin-top:2rem;">
                        <button class="btn-primary"
                            style="width: 100%; max-width: 400px; padding: 1.25rem; font-size: 1.1rem; border-radius: 99px;"
                            onclick="switchTab('assessment')">Start My Assessment</button>
                    </div>
                </div>
            </div>

            <div class="container section-container">
                <!-- Dashboard Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Total Colleges</div>
                        <div class="stat-value" id="dashColleges">...</div>
                        <div class="stat-desc">Participating Institutions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Branches</div>
                        <div class="stat-value" id="dashBranches">...</div>
                        <div class="stat-desc">Engineering Streams</div>
                    </div>
                </div>

                <!-- Steps -->
                <div class="steps-wrapper">
                    <h2 class="section-title" style="text-align:center;">How It Works</h2>
                    <div class="steps-grid">
                        <div class="step-card" onclick="switchTab('cutoff-search')" style="cursor:pointer"
                            title="Go to Search">
                            <div class="step-icon">ðŸŽ¯</div>
                            <h3>Filter</h3>
                            <p style="color:var(--text-muted)">Select your preferred branch and category.</p>
                        </div>
                        <div class="step-card" onclick="switchTab('compare')" style="cursor:pointer"
                            title="Go to Compare Course">
                            <div class="step-icon">ðŸ“Š</div>
                            <h3>Analyze</h3>
                            <p style="color:var(--text-muted)">Compare cutoffs across multiple years.</p>
                        </div>
                        <div class="step-card" onclick="toggleChat()" style="cursor:pointer" title="Open Chat">
                            <div class="step-icon">ðŸ¤–</div>
                            <h3>AI Assist</h3>
                            <p style="color:var(--text-muted)">Use our chat bot for quick college queries.</p>
                        </div>
                    </div>
                </div>

                <!-- Premium CTA Section (Inside Dashboard) -->
                <section class="premium-cta" style="padding: 5rem 0; border-top: 1px solid var(--border);">
                    <div class="container" style="text-align: center;">
                        <h2 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.4; color: var(--text);">
                            Your journey to engineering <br>
                            <span class="gradient-text">success starts here.</span>
                        </h2>
                    </div>
                </section>

                <footer class="footer">
                    <div class="container">
                        <div class="footer-grid">
                            <div class="footer-brand">
                                <div class="logo">
                                    <div class="logo-icon">ðŸŽ“</div>
                                    <div class="logo-text">
                                        <div class="logo-network">TNEA</div>
                                        <div class="logo-sub" style="color: #60a5fa;">Assessment</div>
                                    </div>
                                </div>
                                <p class="footer-tagline">
                                    Every great engineer started with one smart decision. Make yours with clarity,
                                    confidence,
                                    and the right data.
                                </p>
                            </div>

                            <div>
                                <h4 class="footer-heading">Product</h4>
                                <ul class="footer-links">
                                    <li><a class="footer-link" onclick="switchTab('predictor')">Course Predictor</a>
                                    </li>
                                    <li><a class="footer-link" onclick="switchTab('cutoff-search')">Cutoff Search</a>
                                    </li>
                                    <li><a class="footer-link" onclick="switchTab('courses')">Course Insights</a></li>
                                    <li><a class="footer-link" onclick="switchTab('rankings')">Fame Rankings</a></li>
                                </ul>
                            </div>

                            <div>
                                <h4 class="footer-heading">Tools</h4>
                                <ul class="footer-links">
                                    <li><a class="footer-link" onclick="switchTab('assessment')">Career Assessment</a>
                                    </li>
                                    <li><a class="footer-link" onclick="switchTab('compare')">College Comparison</a>
                                    </li>
                                    <li><a class="footer-link" onclick="switchTab('favorites')">Saved Favorites</a></li>
                                    <li><a class="footer-link" onclick="toggleChat()">AI Assistant</a></li>
                                </ul>
                            </div>

                            <div>
                                <h4 class="footer-heading">Legal</h4>
                                <ul class="footer-links">
                                    <li><a class="footer-link" onclick="openLegalModal()">Terms of Use</a></li>
                                    <li><a class="footer-link" onclick="openLegalModal()">Privacy Policy</a></li>
                                    <li><a class="footer-link" onclick="openLegalModal()">Cookie Policy</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="footer-bottom">
                            <p>&copy; 2026 TNEA Assessment. All rights reserved.</p>
                            <div class="social-links">
                                <a href="#" class="social-icon" title="Twitter / X">ð•</a>
                                <a href="#" class="social-icon" title="LinkedIn">in</a>
                                <a href="#" class="social-icon" title="Contact Us">âœ‰ï¸</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </section>

        <!-- Assessment Section -->
        <section id="assessment" class="app-section">
            <div class="container section-container">
                <div class="assessment-container">
                    <h2 class="section-title" style="text-align:center;">Course Assessment</h2>
                    <p style="color:var(--text-muted); text-align:center; margin-bottom:2rem;">Not sure which
                        engineering branch to choose? Take our interest assessment to find your perfect fit.</p>

                    <!-- Back Navigation Bar -->
                    <div id="assessmentBackNav" class="assessment-nav" style="display:none;">
                        <button class="back-btn" onclick="handleAssessmentBack()">
                            <span>â†</span> Back
                        </button>
                        <div class="assessment-steps" id="assessmentStepsIndicators">
                            <div class="step-indicator" data-step="1"></div>
                            <div class="step-indicator" data-step="2"></div>
                            <div class="step-indicator" data-step="3"></div>
                        </div>
                    </div>


                    <div id="academicProfile" class="form-card" style="text-align:center;">
                        <div style="font-size:4rem; margin-bottom:1.5rem;">ðŸŽ“</div>
                        <h3>Welcome, Student!</h3>
                        <p class="form-desc" style="margin-bottom:2rem;">Let's build your academic profile to give you
                            the best career guidance. Are you from a Math or CS background?</p>

                        <div class="academic-group-selector">
                            <button id="groupMath" class="academic-group-btn active"
                                onclick="setAcademicGroup('math')">âž• Math Group</button>
                            <button id="groupCS" class="academic-group-btn" onclick="setAcademicGroup('cs')">ðŸ’» CS
                                Group</button>
                        </div>

                        <div class="mark-input-grid">
                            <div class="mark-field">
                                <label>Mathematics (/100)</label>
                                <input type="number" id="markMath" placeholder="e.g. 95" min="0" max="100">
                            </div>
                            <div class="mark-field">
                                <label>Physics (/100)</label>
                                <input type="number" id="markPhysics" placeholder="e.g. 90" min="0" max="100">
                            </div>
                            <div class="mark-field">
                                <label>Chemistry (/100)</label>
                                <input type="number" id="markChem" placeholder="e.g. 88" min="0" max="100">
                            </div>
                            <div class="mark-field" id="csMarkField" style="display:none;">
                                <label>Computer Science (/100)</label>
                                <input type="number" id="markCS" placeholder="e.g. 98" min="0" max="100">
                            </div>
                            <div class="mark-field">
                                <label>Overall 12th % (Optional)</label>
                                <input type="number" id="markOverall" placeholder="e.g. 92" min="0" max="100">
                            </div>
                        </div>

                        <button class="btn-primary" onclick="proceedToGoalSelection()">Next: Choose Your Goal</button>
                    </div>

                    <!-- Goal Selection Step -->
                    <div id="goalSelection" class="form-card" style="display:none; text-align:center;">
                        <div style="font-size:4rem; margin-bottom:1.5rem;">ðŸŽ¯</div>
                        <h3>What is your Goal?</h3>
                        <p class="form-desc">Select a branch you are most interested in, or use our smart discovery
                            tool.</p>

                        <div
                            style="margin-bottom:2.5rem; padding: 1.5rem; background: var(--surface-hover); border-radius: 12px; border: 1px dashed var(--primary);">
                            <p style="color:var(--text); font-weight: 600; font-size:1rem; margin-bottom:1rem;">Unsure?
                                Let us help you find your path! âœ¨</p>
                            <button class="btn-primary" onclick="proceedToModeSelection()"
                                style="padding: 0.6rem 1.5rem; font-size: 0.9rem;">Help me Discover â†’</button>
                        </div>

                        <div class="goal-selection-grid" id="goalGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>


                    <div id="modeSelection" class="form-card" style="display:none; text-align:center;">
                        <div style="font-size:4rem; margin-bottom:1.5rem;">ðŸ—ï¸</div>
                        <h3>Choose Your Path</h3>
                        <p class="form-desc">What best describes your current situation?</p>

                        <div class="mode-selection">
                            <div class="mode-card" onclick="selectAssessmentMode('discovery')">
                                <div class="mode-icon">ðŸ§­</div>
                                <h4>General Discovery</h4>
                                <p>I'm not sure which engineering branch to choose. Help me explore!</p>
                            </div>
                            <div class="mode-card" onclick="selectAssessmentMode('comparison')">
                                <div class="mode-icon">âš–ï¸</div>
                                <h4>Guided Comparison</h4>
                                <p>I'm confused between 2 or 3 specific branches. Help me decide!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Interest Quiz Question Section -->
                    <div id="interestQuiz" class="form-card" style="display:none; text-align:center;">
                        <div class="quiz-progress-container" style="margin-bottom: 2rem;">
                            <div
                                style="display:flex; justify-content:space-between; margin-bottom:0.5rem; font-size:0.85rem; color:var(--text-muted);">
                                <span id="quizStepText">Question 1 of 30</span>
                                <span id="quizPercentText">0% Complete</span>
                            </div>
                            <div
                                style="height:8px; background:var(--surface-hover); border-radius:4px; overflow:hidden; border:1px solid var(--border);">
                                <div id="quizProgressBar"
                                    style="width: 0%; height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s ease;">
                                </div>
                            </div>
                        </div>
                        <h3 id="quizQuestion" style="font-size:1.5rem; margin-bottom:1rem; color:var(--primary);">
                            Question Text</h3>
                        <p id="quizDesc" style="color:var(--text-muted); margin-bottom:2rem; font-size:0.95rem;">
                            Question description goes here.</p>

                        <div id="quizOptions" class="quiz-options-grid"
                            style="display:flex; flex-direction:column; gap:1rem;">
                            <!-- Options populated by JS -->
                        </div>
                    </div>

                    <div id="branchSelector" class="form-card" style="display:none; text-align:center;">
                        <h3>Which branches are you choosing between?</h3>
                        <p class="form-desc">Select 2 or 3 branches to compare in your assessment.</p>

                        <div class="branch-chips-selector" id="comparisonBranchChips">
                            <!-- Chips populated by JS -->
                        </div>

                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn-primary" id="startComparisonBtn" disabled
                                onclick="showAssessmentResults()">Show Comparison Guidance</button>
                        </div>
                    </div>

                    <div id="resultContainer" class="form-card recommendation-result" style="display:none;">
                        <div class="result-icon">ðŸŽ“</div>
                        <h3 class="result-title">Guidance for You</h3>
                        <p id="resultBranch"
                            style="font-size:1.5rem; font-weight:700; margin-bottom:0.5rem; color:var(--text);">Computer
                            Science & Engineering</p>
                        <div class="result-desc" id="resultDesc">Based on your interests and academic performance.</div>


                        <div class="recommendation-tags" id="resultTags">
                            <!-- Tags populated by JS -->
                        </div>

                        <!-- Guidance & Suggestions Section -->
                        <div id="guidanceSection" class="guidance-section">
                            <div class="guidance-card" id="improvementGuidance">
                                <div class="guidance-header">ðŸ“ˆ Mark Improvement Guidance</div>
                                <div id="improvementTipsList">
                                    <!-- Tips added by JS -->
                                </div>
                            </div>

                            <div class="guidance-card" id="relatedGuidance">
                                <div class="guidance-header">ðŸ¤ Related Course Guidance</div>
                                <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:1rem;">Consider these
                                    related branches that align with your interests:</p>
                                <div id="relatedCoursesList" class="related-courses-box">
                                    <!-- Related courses added by JS -->
                                </div>
                            </div>
                        </div>

                        <div id="comparisonBreakdown" class="comparison-breakdown" style="display:none;">
                            <h4 style="margin-bottom:1rem;">Match Breakdown</h4>
                            <div id="breakdownList">
                                <!-- Breakdown items populated by JS -->
                            </div>
                        </div>

                        <div class="btn-group" style="justify-content:center;">
                            <button class="btn-secondary" onclick="startAssessment()">Retake Quiz</button>
                            <button class="btn-primary" id="exploreRecommended">Explore Branches</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cutoff Data Section -->
        <section id="cutoff-search" class="app-section">
            <div class="container section-container">
                <h2 class="section-title">Search Cutoff Data</h2>

                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Year</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn active year-btn" data-year="2024">2024</button>
                            <button class="btn year-btn" data-year="2023">2023</button>
                        </div>
                    </div>
                    <div class="filter-group" style="flex: 2;">
                        <label class="filter-label">Search</label>
                        <input type="text" class="filter-input" id="searchCollegeInput"
                            placeholder="Search college or branch name...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <select class="filter-select" id="categoryFilter">
                            <option value="OC">OC</option>
                            <option value="BC">BC</option>
                            <option value="BCM">BCM</option>
                            <option value="MBC">MBC</option>
                            <option value="SC">SC</option>
                            <option value="SCA">SCA</option>
                            <option value="ST">ST</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Branch</label>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>College</th>
                                <th>Branch</th>
                                <th>OC</th>
                                <th>BC</th>
                                <th>BCM</th>
                                <th>MBC</th>
                                <th>SC</th>
                                <th>SCA</th>
                                <th>ST</th>
                                <th>Save</th>
                            </tr>
                        </thead>
                        <tbody id="cutoffTable">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </section>

        <!-- Course Insights Section -->
        <section id="courses" class="app-section">
            <div class="container section-container">
                <div class="back-btn" onclick="goBackInsights()">
                    <span>â†</span> Back
                </div>
                <h2 class="section-title">Course Insights & Career Paths</h2>
                <div class="filters">
                    <input type="text" class="filter-input" id="courseSearch"
                        placeholder="Search 50+ engineering branches..." oninput="renderCourseInsights()">
                </div>
                <div class="course-grid" id="courseGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Rankings Section -->
        <section id="rankings" class="app-section">
            <div class="container section-container">
                <h2 class="section-title">NIRF Rankings</h2>
                <div class="filters">
                    <input type="text" class="filter-input" id="rankingSearch" placeholder="Search college rankings...">
                </div>
                <div id="rankingsList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Compare Section -->
        <section id="compare" class="app-section">
            <div class="container section-container">
                <h2 class="section-title">Course & College Comparison</h2>
                <p style="color:var(--text-muted); text-align:center; margin-bottom:2rem;">Make data-driven decisions by
                    comparing colleges or entire engineering branches side-by-side.</p>

                <!-- Comparison Mode Toggle -->
                <div class="compare-toggle-container">
                    <button class="compare-toggle-btn active" onclick="switchCompareMode('college')">Compare
                        Colleges</button>
                    <button class="compare-toggle-btn" onclick="switchCompareMode('branch')">Compare Branches</button>
                </div>

                <!-- College Comparison UI (Default) -->
                <div id="collegeCompareUI">
                    <div class="filters" style="flex-direction:column; gap:1.5rem;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; width:100%;">
                            <div class="filter-group">
                                <label class="filter-label">1. Your Cutoff Mark</label>
                                <input type="number" class="filter-input" id="compareCutoff" placeholder="e.g. 185.5"
                                    oninput="updateCompareBranches()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">2. Category</label>
                                <select class="filter-select" id="compareCategory" onchange="updateCompareBranches()">
                                    <option value="OC">OC</option>
                                    <option value="BC">BC</option>
                                    <option value="BCM">BCM</option>
                                    <option value="MBC" selected>MBC</option>
                                    <option value="SC">SC</option>
                                    <option value="SCA">SCA</option>
                                    <option value="ST">ST</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-group" style="width:100%;">
                            <label class="filter-label">3. Select Course to Compare</label>
                            <select class="filter-select" id="compareBranch" disabled
                                onchange="updateCompareColleges()">
                                <option value="">Enter cutoff first...</option>
                            </select>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; width:100%;">
                            <div class="filter-group">
                                <label class="filter-label">4. College 1</label>
                                <select class="filter-select" id="college1" disabled
                                    onchange="updateComparison()"></select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">5. College 2</label>
                                <select class="filter-select" id="college2" disabled
                                    onchange="updateComparison()"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Branch Comparison UI (New) -->
                <div id="branchCompareUI" style="display:none;">
                    <div class="filters" style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
                        <div class="filter-group">
                            <label class="filter-label">Select Branch A</label>
                            <select class="filter-select" id="branchCompareA" onchange="runBranchComparison()"></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Select Branch B</label>
                            <select class="filter-select" id="branchCompareB" onchange="runBranchComparison()"></select>
                        </div>
                    </div>
                </div>

                <div id="comparisonResult"></div>
                <!-- Final Decision Box -->
                <div id="decisionHelper" style="display:none;"></div>
            </div>
        </section>


        <!-- College Predictor Section -->
        <section id="predictor" class="app-section">
            <div class="container section-container">
                <h2 class="section-title">ðŸ“š Course / Branch Predictor</h2>
                <p style="color:var(--text-muted); margin-bottom:2rem; text-align:center;">Find the best engineering
                    branches based on your score and explore your future career!</p>

                <div class="predictor-container">
                    <!-- Progress Bar -->
                    <div class="predictor-progress">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                        <div class="progress-step active" id="pStep1">
                            <div class="step-circle">1</div>
                            <div class="step-label">Marks</div>
                        </div>
                        <div class="progress-step" id="pStep2">
                            <div class="step-circle">2</div>
                            <div class="step-label">Details</div>
                        </div>
                        <div class="progress-step" id="pStep3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Preferences</div>
                        </div>
                        <div class="progress-step" id="pStep4">
                            <div class="step-circle">4</div>
                            <div class="step-label">Results</div>
                        </div>
                    </div>

                    <!-- Step 1: Enter Marks -->
                    <div class="predictor-step active" id="predStep1">
                        <div class="form-card">
                            <h3>ðŸ“ Enter Your 12th Standard Marks</h3>
                            <p class="form-desc">Enter the marks you scored (out of 100 each) in your HSC (+2)
                                examination.</p>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Mathematics (out of 100)</label>
                                    <input type="number" id="predMaths" min="0" max="100" placeholder="e.g. 95"
                                        oninput="calcPredictorCutoff()">
                                </div>
                                <div class="form-group">
                                    <label>Physics (out of 100)</label>
                                    <input type="number" id="predPhysics" min="0" max="100" placeholder="e.g. 88"
                                        oninput="calcPredictorCutoff()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chemistry (out of 100)</label>
                                    <input type="number" id="predChemistry" min="0" max="100" placeholder="e.g. 82"
                                        oninput="calcPredictorCutoff()">
                                </div>
                                <div class="form-group">
                                    <label>12th Overall % (Optional)</label>
                                    <input type="number" id="predOverall" min="0" max="100" placeholder="e.g. 90"
                                        step="0.1">
                                </div>
                            </div>

                            <div class="cutoff-display">
                                <div class="cutoff-label">Your TNEA Cutoff Mark</div>
                                <div class="cutoff-score" id="predCutoffScore">â€”</div>
                                <div class="cutoff-formula">Formula: Maths + (Physics Ã· 2) + (Chemistry Ã· 2) = Cutoff
                                    out of 200</div>
                            </div>

                            <div class="btn-group">
                                <button class="btn-primary" onclick="predNextStep(2)">Next â†’ Enter Details</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Student Details -->
                    <div class="predictor-step" id="predStep2">
                        <div class="form-card">
                            <h3>ðŸ‘¤ Your Details</h3>
                            <p class="form-desc">This helps us filter colleges based on your category reservation and
                                other factors.</p>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Student Name</label>
                                    <input type="text" id="predName" placeholder="Your full name">
                                </div>
                                <div class="form-group">
                                    <label>School Name (Optional)</label>
                                    <input type="text" id="predSchool" placeholder="e.g. XYZ Higher Sec School">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Community / Caste Category</label>
                                    <select id="predCategory">
                                        <option value="OC">OC (General / Open Category)</option>
                                        <option value="BC">BC (Backward Class)</option>
                                        <option value="BCM">BCM (Backward Class Muslim)</option>
                                        <option value="MBC" selected>MBC (Most Backward Class)</option>
                                        <option value="SC">SC (Scheduled Caste)</option>
                                        <option value="SCA">SCA (Scheduled Caste Arunthathiyar)</option>
                                        <option value="ST">ST (Scheduled Tribe)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>District (Optional)</label>
                                    <input type="text" id="predDistrict" placeholder="e.g. Chennai, Coimbatore">
                                </div>
                            </div>

                            <div class="btn-group">
                                <button class="btn-secondary" onclick="predNextStep(1)">â† Back</button>
                                <button class="btn-primary" onclick="predNextStep(3)">Next â†’ Preferences</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Preferences -->
                    <div class="predictor-step" id="predStep3">
                        <div class="form-card">
                            <h3>â­ Targeted Discovery</h3>
                            <p class="form-desc">Based on your score, these branches are best suited for you. Select the
                                ones you're interested in.</p>

                            <div class="form-group">
                                <label>Search Branches</label>
                                <input type="text" id="branchSearch" class="filter-input" style="margin-bottom: 1rem;"
                                    placeholder="e.g. Computer, AI, IT..." oninput="filterBranchChips()">
                                <div id="branchDiscoveryGrid" class="course-grid"
                                    style="margin-bottom: 1.5rem; max-height: 400px; overflow-y: auto;">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <div class="form-group" style="margin-top:1.5rem;">
                                <label>How many results to show?</label>
                                <select id="predResultCount" class="filter-select">
                                    <option value="25">Top 25 options</option>
                                    <option value="50" selected>Top 50 options</option>
                                    <option value="100">Top 100 options</option>
                                    <option value="999">Show all matching</option>
                                </select>
                            </div>

                            <div class="btn-group">
                                <button class="btn-secondary" onclick="predNextStep(2)">â† Back</button>
                                <button class="btn-primary" onclick="runPredictor()">âœ¨ Predict My Colleges</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="predictor-step" id="predStep4">
                <div id="predictorResults">
                    <!-- Populated by JS -->
                </div>
                <div class="btn-group" style="margin-top:2rem;">
                    <button class="btn-secondary" onclick="predNextStep(1)">ðŸ”„ Start Over</button>
                    <button class="btn-primary" onclick="printResults()">ðŸ–¨ï¸ Print / Save</button>
                </div>
            </div>
            </div>
            </div>
        </section>

        <!-- Favorites Section -->
        <section id="favorites" class="app-section">
            <div class="container section-container">
                <h2 class="section-title">â¤ï¸ My Favorite Colleges</h2>
                <p style="color:var(--text-muted); margin-bottom:2rem; text-align:center;">Your saved colleges and
                    branches in one place.</p>
                <div id="favoritesList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Modals Overlay -->
        <div class="modal-overlay hidden" id="courseDetailModal">
            <div class="course-modal">
                <button class="modal-close" onclick="closeCourseModal()">âœ•</button>
                <div id="courseModalContent">
                    <!-- Populated by JS -->
                </div>
                <div
                    style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border); display:flex; justify-content:center;">
                    <button id="favBranchBtn" class="btn-primary"
                        style="background:var(--surface); color:var(--primary); border:2px solid var(--primary);">
                        â¤ï¸ Save Branch to Favorites
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div class="modal-overlay hidden" id="loginModal">
            <div class="login-modal">
                <div class="modal-header">
                    <div class="modal-icon">ðŸŽ“</div>
                    <h2 id="loginModalTitle">Welcome Back</h2>
                    <p id="loginModalSubtitle">Login to save your favorite colleges</p>
                </div>
                <div class="login-error" id="loginError"></div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username"
                        onkeypress="if(event.key==='Enter') handleLogin()">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password"
                        onkeypress="if(event.key==='Enter') handleLogin()">
                </div>
                <div class="forgot-link-wrapper" id="forgotPwdWrapper">
                    <a class="forgot-password-link" onclick="handleForgotPassword()">Forgot password?</a>
                </div>
                <div class="form-group" id="loginNameGroup" style="display:none">
                    <label>Full Name</label>
                    <input type="text" id="loginFullName" placeholder="Your full name">
                </div>
                <button class="login-btn" onclick="handleLogin()" id="loginSubmitBtn">Login</button>

                <div class="auth-separator" id="authSeparator">OR</div>

                <button class="login-google-btn" onclick="handleGoogleLogin()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon"
                        alt="Google">
                    <span>Continue with Google</span>
                </button>
                <div class="toggle-mode">
                    <span id="toggleText">Don't have an account? </span>
                    <a onclick="toggleLoginMode()" id="toggleLink">Register</a>
                </div>
                <div class="guest-link">
                    <a onclick="closeLoginModal()">Continue as guest â†’</a>
                </div>
            </div>
        </div>

        <!-- Legal Modal (Terms and Conditions) -->
        <div class="modal-overlay hidden" id="legalModal">
            <div class="course-modal" style="max-width: 800px;">
                <button class="modal-close" onclick="closeLegalModal()">âœ•</button>
                <div class="modal-header">
                    <h2 style="color: var(--primary); text-align: center; margin-bottom: 1rem;">Terms and Conditions
                    </h2>
                    <p style="text-align: center; margin-bottom: 2rem;">Please read these terms carefully before using
                        the TNEA Assessment platform.</p>
                </div>
                <div class="legal-content">
                    <h3>1. Acceptance of Terms</h3>
                    <p>By accessing and using this platform, you agree to be bound by these Terms and Conditions. This
                        platform is designed for educational guidance and analytical purposes related to TNEA
                        admissions.</p>

                    <h3>2. Use of Services</h3>
                    <p>Our platform provides various tools to help you navigate your TNEA journey:</p>
                    <ul>
                        <li><strong>Course Predictor:</strong> Uses historical data to estimate potential college
                            placements.</li>
                        <li><strong>Cutoff Search:</strong> Provides searchable access to past years' cutoff trends.
                        </li>
                        <li><strong>Rankings:</strong> Displays NIRF and other institutional rankings for informed
                            decision making.</li>
                        <li><strong>Assessment:</strong> Offers a guided workflow to help students identify their
                            engineering goals and group interests.</li>
                    </ul>

                    <h3>3. Data Accuracy & Disclaimer</h3>
                    <p>While we strive for 100% accuracy, all data provided is for informational purposes only. The
                        official TNEA cutoff data released by Anna University should be considered the final source of
                        truth.</p>

                    <h3>4. User Conduct</h3>
                    <p>Users are expected to use the AI Assistant and Assessment tools responsibly. Any attempt to
                        manipulate the platform's data or disrupt services is strictly prohibited.</p>

                    <h3>5. Privacy</h3>
                    <p>Your privacy is important to us. We use localStorage to save your favorites and profile data
                        locally on your device. We do not store sensitive personal information on our servers.</p>
                </div>
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn-primary" onclick="closeLegalModal()">I Understand</button>
                </div>
            </div>
        </div>


        <!-- Chat Bot UI -->
        <button class="chatbot-btn" onclick="toggleChat()" title="Chat with AI">
            <span style="font-size: 1.5rem;">ðŸ¤–</span>
            <span>Chat AI</span>
        </button>

        <div class="chatbot-window" id="chatWindow">
            <div class="chat-header">
                <span>TNEA AI Assistant</span>
                <span style="cursor:pointer" onclick="toggleChat()">âœ•</span>
            </div>
            <div class="chat-body" id="chatBody">
                <div class="message bot">
                    Hello! I'm your TNEA AI Assistant. I can help you find colleges, understand cutoffs, and explore
                    course career paths.
                    How can I help you today?
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    AI is thinking...
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-chips" id="chatChips">
                    <div class="chat-chip" onclick="quickChat('Best CSE Colleges')">ðŸ† Best CSE Colleges</div>
                    <div class="chat-chip" onclick="quickChat('My cutoff is 190, help!')">ðŸŽ¯ 190 Cutoff Help</div>
                    <div class="chat-chip" onclick="quickChat('Market Demand for AI')">ðŸ“ˆ AI Market Demand</div>
                </div>
                <div style="display:flex; gap:0.5rem; width:100%;">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything about TNEA..."
                        onkeypress="handleChatKey(event)">
                    <button class="chat-send" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>

        <div id="js-loading-indicator"
            style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <h2>Loading Application...</h2>
            <p>If this stays for more than 5 seconds, an error occurred.</p>
            <div id="error-display"
                style="color:red; margin-top:1rem; padding:1rem; border:1px solid red; max-width:80%; display:none;">
            </div>
        </div>

        <script>
            // Global Error Handler - MUST BE FIRST
            window.onerror = function (msg, url, line, col, error) {
                const display = document.getElementById('error-display');
                if (display) {
                    display.style.display = 'block';
                    display.innerHTML += `<strong>Error:</strong> ${msg}<br><small>${url}:${line}:${col}</small><br><br>`;
                }
                // alert("Critical Error: " + msg + "\nLine: " + line);
                return false;
            };
        </script>

        <script>

            // Global State
            let appState = {
                cutoffData2024: [],
                cutoffData2023: [],
                courseInsights: [],
                rankings: [],
                currentData: [],
                currentPage: 1,
                year: '2024',
                currentPageTab: 'dashboard',
                previousTab: 'dashboard'
            };

            // Remove loading indicator when done
            function hideLoadingIndicator() {
                const el = document.getElementById('js-loading-indicator');
                if (el) el.style.display = 'none';
            }

            const ITEMS_PER_PAGE = 25;

            // --- Navigation ---
            function switchTab(tabId) {
                // Close mobile menu if open
                const navLinks = document.getElementById('navLinks');
                if (navLinks && navLinks.classList.contains('active')) {
                    toggleMenu && toggleMenu();
                }

                if (appState.currentPageTab !== tabId) {
                    appState.previousTab = appState.currentPageTab;
                }
                appState.currentPageTab = tabId;

                // Hide all sections
                document.querySelectorAll('.app-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Deactivate all links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show active section
                const targetSection = document.getElementById(tabId);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                // Set active link in main nav
                const targetLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
                if (targetLink) {
                    targetLink.classList.add('active');
                }

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }


            function goBackInsights() {
                if (appState.previousTab && appState.previousTab !== 'courses') {
                    switchTab(appState.previousTab);
                } else {
                    switchTab('dashboard');
                }
            }

            // --- Data Loading ---
            async function loadData() {
                // Show loading state
                const tbl = document.getElementById('cutoffTable');
                if (tbl) tbl.innerHTML = '<tr><td colspan="10"><div class="text-center p-4">Loading Data...</div></td></tr>';

                try {
                    const fetchJson = async (url) => {
                        const r = await fetch(url);
                        if (!r.ok) throw new Error('HTTP error ' + r.status);
                        return r.json();
                    };

                    // Load all data
                    const [cut24, cut23, courses, ranks] = await Promise.all([
                        fetchJson('TNEA2024CutOff.json').catch(e => []),
                        fetchJson('TNEA2023CutOff.json').catch(e => []),
                        fetchJson('TNEAcourseInsights.json').catch(e => ({})),
                        fetchJson('2024_TNEA_NIRF_Ranking.json').catch(e => [])
                    ]);

                    // Populate State
                    appState.cutoffData2024 = (cut24 && cut24.length) ? cut24 : generateSampleData();
                    appState.cutoffData2023 = cut23 || [];
                    appState.courseInsights = courses ? Object.entries(courses).map(([name, info]) => ({ name: name.trim(), ...info })) : [];
                    appState.rankings = ranks || [];
                    appState.currentData = appState.cutoffData2024;

                    // Render
                    renderAll();
                    hideLoadingIndicator();

                    // Optional Compare pre-fill
                    if (appState.cutoffData2024.length > 0) {
                        try {
                            const el = document.getElementById('compareCutoff');
                            if (el) {
                                el.value = 180;
                                updateCompareBranches();
                            }
                        } catch (e) { console.warn("Compare auto-fill error", e); }
                    }

                } catch (e) {
                    console.error("Init Error", e);
                    alert("Init Error: " + e.message);
                    appState.cutoffData2024 = generateSampleData();
                    appState.currentData = appState.cutoffData2024;
                    renderAll();
                    hideLoadingIndicator();
                }
            }

            function generateSampleData() {
                // Fallback for demo if files missing
                const colleges = [
                    'University Departments of Anna University Chennai - CEG Campus',
                    'University Departments of Anna University Chennai - ACT Campus',
                    'University Departments of Anna University Chennai - MIT Campus',
                    'College of Engineering Guindy',
                    'PSG College of Technology',
                    'Coimbatore Institute of Technology'
                ];
                const data = [];
                colleges.forEach((c, i) => {
                    data.push({
                        con: c, brc: 'CS', brn: 'COMPUTER SCIENCE',
                        OC: 195 - i, BC: 190 - i, MBC: 185 - i
                    });
                });
                return data;
            }

            // --- Rendering ---
            function renderAll() {
                populateBranchFilter();
                renderCutoffTable();
                renderCourseInsights();
                renderRankings();
                updateDashboardStats(); // Important: Render dashboard stats
            }

            function updateDashboardStats() {
                const data = appState.cutoffData2024;
                if (!data || data.length === 0) return;

                // 1. Stats Cards
                const colleges = new Set(data.map(d => d.con)).size;
                const branches = new Set(data.map(d => d.brc)).size;

                document.getElementById('dashColleges').innerText = colleges;
                document.getElementById('dashBranches').innerText = branches;
            }

            // 1. Cutoff Table
            function renderCutoffTable() {
                const tbody = document.getElementById('cutoffTable');
                const searchCollege = document.getElementById('searchCollegeInput').value.toLowerCase();
                const category = document.getElementById('categoryFilter').value;
                const branch = document.getElementById('branchFilter').value;
                const year = appState.year;

                // Use correct dataset
                const sourceData = year === '2024' ? appState.cutoffData2024 : appState.cutoffData2023;

                // Filter
                const filtered = sourceData.filter(item => {
                    const s = searchCollege;
                    // Strict College Name 'Starts With' Search
                    const matchesSearch = !s || (item.con && item.con.toLowerCase().startsWith(s));
                    const matchesBranch = !branch || item.brc === branch;
                    return matchesSearch && matchesBranch;
                });

                // Pagination
                const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
                const start = (appState.currentPage - 1) * ITEMS_PER_PAGE;
                const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);

                if (pageData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 2rem;">No results found</td></tr>`;
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                tbody.innerHTML = pageData.map(item => {
                    const favKey = `${item.con}||${item.brc}`;
                    const isSaved = isFavorite(favKey);
                    return `
                <tr>
                    <td><span class="branch-code">${item.brc || '-'}</span></td>
                    <td title="${item.con}">${item.con}</td>
                    <td>${item.brn}</td>
                    <td class="cutoff-value ${getCutoffClass(item.OC)}">${item.OC || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.BC)}">${item.BC || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.BCM)}">${item.BCM || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.MBC)}">${item.MBC || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.SC)}">${item.SC || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.SCA)}">${item.SCA || '-'}</td>
                    <td class="cutoff-value ${getCutoffClass(item.ST)}">${item.ST || '-'}</td>
                    <td><button class="fav-btn ${isSaved ? 'saved' : ''}" onclick="toggleFavorite('${favKey.replace(/'/g, "\\'")}', this, ${JSON.stringify(item).replace(/"/g, '&quot;')})" title="${isSaved ? 'Remove from favorites' : 'Save to favorites'}">${isSaved ? 'â¤ï¸' : 'ðŸ¤'}</button></td>
                </tr>
            `}).join('');

                renderPagination(totalPages);
            }

            function getCutoffClass(val) {
                if (!val) return '';
                const n = parseFloat(val);
                if (n > 185) return 'high';
                if (n > 160) return 'medium';
                return 'low';
            }

            function renderPagination(total) {
                const el = document.getElementById('pagination');
                if (total <= 1) { el.innerHTML = ''; return; }

                const curr = appState.currentPage;
                let html = `
                <button class="btn" onclick="changePage(${curr - 1})" ${curr === 1 ? 'disabled' : ''}>Prev</button>
                <span style="display:flex; align-items:center; padding:0 1rem; color:var(--text-muted)">Page ${curr} of ${total}</span>
                <button class="btn" onclick="changePage(${curr + 1})" ${curr === total ? 'disabled' : ''}>Next</button>
            `;
                el.innerHTML = html;
            }

            function changePage(p) {
                appState.currentPage = p;
                renderCutoffTable();
            }

            // 2. Filters
            function populateBranchFilter() {
                const select = document.getElementById('branchFilter');
                // Create a map of code -> name to ensure unique branches
                const branchMap = new Map();
                appState.currentData.forEach(d => {
                    if (d.brc && d.brn && !branchMap.has(d.brc)) {
                        branchMap.set(d.brc, d.brn);
                    }
                });

                // Sort by branch code
                const sortedBranches = Array.from(branchMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

                select.innerHTML = '<option value="">All Branches</option>' +
                    sortedBranches.map(([code, name]) => `<option value="${code}">${code} - ${name}</option>`).join('');
            }

            function populateCollegeSelects() {
                const colleges = [...new Set(appState.currentData.map(d => d.con))].filter(Boolean).sort();
                const opts = '<option value="">Select College</option>' +
                    colleges.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('college1').innerHTML = opts;
                document.getElementById('college2').innerHTML = opts;
            }

            // 3. Course Insights
            function renderCourseInsights() {
                const grid = document.getElementById('courseGrid');
                const termInput = document.getElementById('courseSearch');
                const term = termInput ? termInput.value.toLowerCase().trim() : '';

                let displayData = [];
                let isSearchMode = term.length > 0;

                if (!isSearchMode) {
                    // Default view: Show main branches from branchMapping
                    displayData = Object.keys(branchMapping).map(key => {
                        const b = branchMapping[key];
                        // Try to find matching data in appState.courseInsights for salary/metadata
                        const extra = appState.courseInsights.find(c =>
                            c.name.toLowerCase().includes(b.name.toLowerCase()) ||
                            b.name.toLowerCase().includes(c.name.toLowerCase())
                        ) || {};

                        return {
                            name: b.name,
                            key: key,
                            description: b.desc,
                            future: b.future,
                            career: b.career,
                            suitability: b.suitability,
                            demand: extra['Market Demand'] || 'Very High',
                            salary: extra['Salary'] ? (typeof extra['Salary'] === 'string' ? extra['Salary'] : extra['Salary']['Entry']) : 'Premium',
                            concepts: b.tags || [],
                            isAdvisor: true,
                            pros: b.pros || [],
                            cons: b.cons || []
                        };
                    });
                } else {
                    // Search mode: Merge both sources to ensure all 20+ branches are searchable
                    const branchMappingResults = Object.keys(branchMapping)
                        .filter(key => branchMapping[key].name.toLowerCase().includes(term) || key.includes(term))
                        .map(key => {
                            const b = branchMapping[key];
                            const extra = appState.courseInsights.find(c =>
                                c.name.toLowerCase().includes(b.name.toLowerCase()) ||
                                b.name.toLowerCase().includes(c.name.toLowerCase())
                            ) || {};
                            return {
                                name: b.name,
                                key: key,
                                description: b.desc,
                                future: b.future,
                                career: b.career,
                                suitability: b.suitability,
                                demand: extra['Market Demand'] || 'Very High',
                                salary: extra['Salary'] ? (typeof extra['Salary'] === 'string' ? extra['Salary'] : extra['Salary']['Entry']) : 'Premium',
                                concepts: b.tags || [],
                                isAdvisor: true,
                                pros: b.pros || [],
                                cons: b.cons || []
                            };
                        });

                    const insightResults = appState.courseInsights
                        .filter(c => c.name.toLowerCase().includes(term))
                        .filter(c => !branchMappingResults.some(br => br.name.toLowerCase() === c.name.toLowerCase()))
                        .map(c => {
                            const mappedKey = Object.keys(branchMapping).find(key =>
                                branchMapping[key].name.toLowerCase().includes(c.name.toLowerCase()) ||
                                c.name.toLowerCase().includes(branchMapping[key].name.toLowerCase())
                            );

                            return {
                                name: c.name,
                                key: mappedKey,
                                description: c['Course Description'] || 'No description available.',
                                future: mappedKey ? branchMapping[mappedKey].future : null,
                                career: mappedKey ? branchMapping[mappedKey].career : null,
                                demand: c['Market Demand'] || 'High',
                                salary: c['Salary'] ? (typeof c['Salary'] === 'string' ? c['Salary'] : c['Salary']['Entry']) : 'N/A',
                                concepts: c['Fundamental Concepts'] || [],
                                isAdvisor: !!mappedKey,
                                pros: mappedKey ? branchMapping[mappedKey].pros : [],
                                cons: mappedKey ? branchMapping[mappedKey].cons : []
                            };
                        });

                    displayData = [...branchMappingResults, ...insightResults];
                }


                grid.innerHTML = displayData.map(c => {
                    const isFav = isBranchFavorite(c.name);
                    return `
                    <div class="course-card" style="display:flex; flex-direction:column; height:100%; position:relative; overflow:hidden;">
                        ${c.isAdvisor ? `<div style="position:absolute; top:0; right:0; background:var(--primary); color:white; font-size:10px; padding:2px 8px; border-bottom-left-radius:8px; font-weight:bold; letter-spacing:0.5px;">ADVISOR CHOICE</div>` : ''}
                        
                        <div style="display:flex; justify-content:space-between; align-items:start; gap:0.75rem; margin-bottom:0.75rem; flex-wrap:wrap;">
                            <div style="flex:1;">
                                <h3 style="margin:0; font-size:1.1rem; line-height:1.3; color:var(--primary);">${c.name}</h3>
                                <div style="display:flex; gap:0.5rem; margin-top:0.4rem;">
                                    <span style="font-size:0.65rem; background:rgba(59, 130, 246, 0.15); color:var(--primary); padding:0.2rem 0.6rem; border-radius:12px; font-weight:700; border:1px solid rgba(59, 130, 246, 0.2);">${c.demand}</span>
                                    <span style="font-size:0.65rem; background:rgba(16, 185, 129, 0.1); color:var(--success); padding:0.2rem 0.6rem; border-radius:12px; font-weight:700;">â‚¹ ${c.salary}</span>
                                </div>
                            </div>
                            <button class="fav-btn ${isFav ? 'saved' : ''}" 
                                    onclick="toggleBranchFavorite('${c.name.replace(/'/g, "\\'")}', this)" 
                                    style="padding:8px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:10px; background:var(--surface);"
                                    title="${isFav ? 'Remove from favorites' : 'Save to favorites'}">
                                ${isFav ? 'â¤ï¸' : 'ðŸ¤'}
                            </button>
                        </div>

                        <p style="font-size:0.85rem; color:var(--text-muted); line-height:1.5; margin-bottom:1rem;">${c.description}</p>

                        <div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:1rem; margin-bottom:1rem;">
                            <div style="font-size:0.75rem; font-weight:700; color:var(--primary); text-transform:uppercase; margin-bottom:0.75rem; letter-spacing:0.5px;">ðŸ’¡ Why choose this?</div>
                            <div style="display:flex; flex-direction:column; gap:0.5rem;">
                                ${c.pros.slice(0, 2).map(p => `
                                    <div style="display:flex; align-items:start; gap:0.5rem; font-size:0.8rem; color:var(--text);">
                                        <span style="color:var(--success);">Check</span> <span>${p}</span>
                                    </div>
                                `).join('')}
                                ${c.cons.slice(0, 1).map(cn => `
                                    <div style="display:flex; align-items:start; gap:0.5rem; font-size:0.8rem; color:var(--text-muted);">
                                        <span style="color:var(--accent);">Info</span> <span>Challenge: ${cn}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        ${c.future ? `
                        <div class="course-meta-section">
                            <div class="course-meta-title"><span>ðŸ”­</span> The Future Scope</div>
                            <div class="course-meta-text" style="font-size:0.8rem;">${c.future}</div>
                        </div>
                        ` : ''}

                        ${c.key && relatedCoursesData[c.key] ? `
                        <div class="course-meta-section" style="border-top:1px dashed var(--border); padding-top:0.75rem; margin-top:0.5rem;">
                            <div class="course-meta-title" style="color:var(--primary); font-size:0.75rem;"><span>ðŸ”—</span> Related Paths</div>
                            <div style="display:flex; flex-wrap:wrap; gap:0.3rem; margin-top:0.3rem;">
                                ${relatedCoursesData[c.key].map(rel => `
                                    <span style="font-size:0.7rem; background:rgba(59, 130, 246, 0.05); color:var(--text); padding:0.15rem 0.5rem; border-radius:4px; border:1px solid var(--border);">
                                        ${rel.why}: <strong>${branchMapping[rel.key] ? branchMapping[rel.key].name.split(' ')[0] : rel.key}</strong>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div style="margin-top:auto; padding-top:1rem; display:flex; justify-content:center;">
                            <button class="btn-primary" style="width:100%; padding:0.5rem; font-size:0.8rem; border-radius:8px;" onclick="toggleChatWithCourse('${c.name.replace(/'/g, "\\'")}')">
                                ðŸ’¬ Ask AI about this course
                            </button>
                        </div>
                    </div>
                    `;
                }).join('') || '<p style="text-align:center; grid-column:1/-1; padding:3rem; color:var(--text-muted);">No courses found matching your search.</p>';
            }


            function switchCompareMode(mode) {
                // Update tabs
                document.querySelectorAll('.compare-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.innerText.toLowerCase().includes(mode)) btn.classList.add('active');
                });

                // Update UI Containers
                document.getElementById('collegeCompareUI').style.display = mode === 'college' ? 'block' : 'none';
                document.getElementById('branchCompareUI').style.display = mode === 'branch' ? 'block' : 'none';

                // Reset Results
                document.getElementById('comparisonResult').innerHTML = '';
                document.getElementById('decisionHelper').style.display = 'none';

                if (mode === 'branch') {
                    populateBranchCompareSelects();
                }
            }

            function populateBranchCompareSelects() {
                const s1 = document.getElementById('branchCompareA');
                const s2 = document.getElementById('branchCompareB');

                const sortedCourses = [...appState.courseInsights].sort((a, b) => a.name.localeCompare(b.name));
                const options = '<option value="">-- Select Branch --</option>' +
                    sortedCourses.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                s1.innerHTML = options;
                s2.innerHTML = options;
            }

            function runBranchComparison() {
                const b1Name = document.getElementById('branchCompareA').value;
                const b2Name = document.getElementById('branchCompareB').value;
                const resultDiv = document.getElementById('comparisonResult');
                const helperDiv = document.getElementById('decisionHelper');

                if (!b1Name || !b2Name) {
                    resultDiv.innerHTML = '';
                    helperDiv.style.display = 'none';
                    return;
                }

                const b1 = appState.courseInsights.find(c => c.name === b1Name);
                const b2 = appState.courseInsights.find(c => c.name === b2Name);

                // Find advisor mapping for extra career details
                const m1 = Object.values(branchMapping).find(m => b1Name.toLowerCase().includes(m.name.split(' ')[0].toLowerCase())) || {};
                const m2 = Object.values(branchMapping).find(m => b2Name.toLowerCase().includes(m.name.split(' ')[0].toLowerCase())) || {};

                const renderCard = (data, mapping, isLeft) => {
                    const complexity = parseInt(data['Course Complexity']) || 7;
                    const entrySalary = mapping.pros?.find(p => p.includes('salary')) ? 'High' : (data.Salary?.Entry || 'Standard');

                    return `
                    <div class="branch-compare-card">
                        ${!isLeft ? '<div class="compare-v-badge">VS</div>' : ''}
                        <h3 style="color:var(--primary); margin-bottom:1rem; font-size:1.4rem;">${data.name}</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:1.5rem; line-height:1.5;">${data['Course Description'] || mapping.desc || 'No description'}</p>
                        
                        <div class="comparison-metrics">
                            <div class="comparison-metric-row">
                                <span class="metric-label">ðŸ“Š Market Demand</span>
                                <span class="metric-value">${data['Market Demand'] || 'High'}</span>
                            </div>
                            <div class="comparison-metric-row">
                                <span class="metric-label">ðŸ’° Entry Salary</span>
                                <span class="metric-value">â‚¹ ${entrySalary}</span>
                            </div>
                            <div class="comparison-metric-row">
                                <span class="metric-label">ðŸ§  Complexity</span>
                                <span class="metric-value">${complexity}/10</span>
                            </div>
                            <div class="comparison-metric-row">
                                <span class="metric-label">ðŸ”­ Future Trend</span>
                                <span class="metric-value">${(data['Industry Trends'] || []).slice(0, 2).join(', ') || mapping.future || 'Growing'}</span>
                            </div>
                        </div>

                        <div style="margin-top:1.5rem;">
                            <span class="metric-label">âœ… Best for you if:</span>
                            <p style="font-size:0.85rem; color:var(--text);">${mapping.suitability || 'You are interested in this field.'}</p>
                        </div>
                    </div>
                `;
                };

                resultDiv.innerHTML = `
                    <div class="branch-comparison-grid">
                        ${renderCard(b1, m1, true)}
                        ${renderCard(b2, m2, false)}
                    </div>
                `;

                // Render Advisor Helper
                helperDiv.style.display = 'block';
                renderDecisionAdvisor(b1, b2, m1, m2);
            }

            function renderDecisionAdvisor(b1, b2, m1, m2) {
                const helper = document.getElementById('decisionHelper');

                // Simple Logic for recommendations
                const pay1 = parseInt((b1.Salary?.Entry || '0').replace(/[^0-9]/g, '')) || 4;
                const pay2 = parseInt((b2.Salary?.Entry || '0').replace(/[^0-9]/g, '')) || 4;
                const comp1 = parseInt(b1['Course Complexity']) || 7;
                const comp2 = parseInt(b2['Course Complexity']) || 7;

                let recommendation = "";
                let roiBranch = pay1 / comp1 > pay2 / comp2 ? b1.name : b2.name;
                let demandBranch = b1['Market Demand'].toLowerCase().includes('very high') ? b1.name : (b2['Market Demand'].toLowerCase().includes('very high') ? b2.name : "Both");

                if (pay1 > pay2 + 1) {
                    recommendation = `If financial ROI is your top priority, **${b1.name}** generally offers a stronger starting package. `;
                } else if (pay2 > pay1 + 1) {
                    recommendation = `If financial ROI is your top priority, **${b2.name}** generally offers a stronger starting package. `;
                } else {
                    recommendation = `Both branches have similar pay scales. Your choice should depend on whether you prefer **${m1.tags?.join('/') || 'this field'}** or **${m2.tags?.join('/') || 'that field'}**. `;
                }

                if (comp1 > comp2 + 1) {
                    recommendation += `Note that **${b1.name}** is significantly more academic or rigorous. `;
                }

                helper.innerHTML = `
                    <div class="decision-helper-box">
                        <div class="advisor-title">
                            <div class="advisor-avatar">ðŸ‘©â€ðŸ«</div>
                            <span>Career Advisor's Final Take</span>
                        </div>
                        <div class="advisor-content">
                            <p>${recommendation}</p>
                            <div style="display:flex; gap:1rem; margin-top:1.5rem; flex-wrap:wrap;">
                                <div class="roi-badge">ðŸš€ Best ROI: ${roiBranch}</div>
                                <div class="roi-badge" style="background:rgba(37,99,235,0.1); color:var(--primary);">ðŸ“ˆ Top Demand: ${demandBranch}</div>
                            </div>
                            <p style="margin-top:1rem; font-size:0.9rem; color:var(--text-muted);">
                                <strong>Advisor Tip:</strong> Don't just follow the money. Choose **${b1.name}** if you enjoy ${m1.suitability?.toLowerCase() || 'problem solving'}. Choose **${b2.name}** if you prefer ${m2.suitability?.toLowerCase() || 'technical challenges'}.
                            </p>
                        </div>
                    </div>
                `;
            }


            function toggleChatWithCourse(courseName) {
                if (!document.getElementById('chatWindow').classList.contains('open')) {
                    toggleChat();
                }
                const input = document.getElementById('chatInput');
                input.value = `Tell me more about ${courseName}`;
                sendChatMessage();
            }

            // 4. Rankings
            function openLegalModal() {
                document.getElementById('legalModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeLegalModal() {
                document.getElementById('legalModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            function renderRankings() {
                const list = document.getElementById('rankingsList');
                const term = document.getElementById('rankingSearch').value.toLowerCase();
                const filtered = appState.rankings.filter(r => r.college.toLowerCase().includes(term));

                if (!filtered.length) {
                    list.innerHTML = `<p style="text-align:center">No rankings found</p>`;
                    return;
                }

                // Sort by ranking (ascending)
                filtered.sort((a, b) => parseInt(a.ranking) - parseInt(b.ranking));

                list.innerHTML = filtered.slice(0, 50).map(r => `
                <div style="background:var(--surface); padding:1rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:600">${r.college}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted)">State: ${r.state || 'TN'}</div>
                    </div>
                    <div style="background:var(--primary); color:white; padding:0.5rem 1rem; border-radius:8px; font-weight:bold;">#${r.ranking}</div>
                </div>
             `).join('');
            }


            // 5. Compare Logic - REFACTORED FLOW
            function updateCompareBranches() {
                const cutoff = parseFloat(document.getElementById('compareCutoff').value);
                const category = document.getElementById('compareCategory').value;
                const branchSelect = document.getElementById('compareBranch');
                const c1 = document.getElementById('college1');
                const c2 = document.getElementById('college2');

                if (isNaN(cutoff)) {
                    branchSelect.innerHTML = '<option value="">Enter cutoff first...</option>';
                    branchSelect.disabled = true;
                    c1.disabled = true;
                    c2.disabled = true;
                    return;
                }

                // Find all branches where student qualifies in at least one college
                const data = appState.cutoffData2024;
                const eligibleBranches = new Set();
                data.forEach(item => {
                    const itemCutoff = parseFloat(item[category]);
                    if (!isNaN(itemCutoff) && itemCutoff <= cutoff) {
                        eligibleBranches.add(`${item.brc}||${item.brn}`);
                    }
                });

                const sortedBranches = Array.from(eligibleBranches).sort();
                branchSelect.innerHTML = '<option value="">Select a Course</option>' +
                    sortedBranches.map(b => {
                        const [code, name] = b.split('||');
                        return `<option value="${code}">${code} - ${name}</option>`;
                    }).join('');

                branchSelect.disabled = false;
                c1.disabled = true;
                c2.disabled = true;
                document.getElementById('comparisonResult').innerHTML = '';
            }

            function updateCompareColleges() {
                const cutoff = parseFloat(document.getElementById('compareCutoff').value);
                const category = document.getElementById('compareCategory').value;
                const branchCode = document.getElementById('compareBranch').value;
                const c1 = document.getElementById('college1');
                const c2 = document.getElementById('college2');

                if (!branchCode) {
                    c1.disabled = true;
                    c2.disabled = true;
                    return;
                }

                // Find colleges offering this branch where student qualifies
                const data = appState.cutoffData2024.filter(item => {
                    const itemCutoff = parseFloat(item[category]);
                    return item.brc === branchCode && !isNaN(itemCutoff) && itemCutoff <= cutoff;
                });

                const uniqueColleges = [...new Set(data.map(d => d.con))].sort();
                const options = '<option value="">Select College</option>' +
                    uniqueColleges.map(c => `<option value="${c}">${c}</option>`).join('');

                c1.innerHTML = options;
                c2.innerHTML = options;
                c1.disabled = false;
                c2.disabled = false;
                document.getElementById('comparisonResult').innerHTML = '';
            }

            function updateComparison() {
                const c1 = document.getElementById('college1').value;
                const c2 = document.getElementById('college2').value;
                const branchCode = document.getElementById('compareBranch').value;
                const res = document.getElementById('comparisonResult');

                if (!c1 || !c2 || !branchCode) {
                    res.innerHTML = '';
                    return;
                }

                const data1 = appState.cutoffData2024.find(d => d.con === c1 && d.brc === branchCode);
                const data2 = appState.cutoffData2024.find(d => d.con === c2 && d.brc === branchCode);

                const categories = ['OC', 'BC', 'BCM', 'MBC', 'SC', 'SCA', 'ST'];
                const getCourseInsight = (branchName) => {
                    if (!branchName) return null;
                    const searchName = branchName.toUpperCase();
                    return appState.courseInsights.find(c =>
                        c.name === searchName ||
                        searchName.includes(c.name) ||
                        c.name.includes(searchName)
                    );
                };

                const renderCourseInfo = (insight) => {
                    if (!insight) return `<p style="color:var(--text-muted); font-size:0.85rem; text-align:center; padding:1rem;">Additional course details not available.</p>`;
                    return `
                    <div style="padding:1rem; background:rgba(255,255,255,0.02); border-radius:10px; margin-top:1rem; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem;">
                            <span style="font-size:0.75rem; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:0.05em;">Course Insight</span>
                            <span class="tag" style="font-size:0.65rem; background:rgba(37,99,235,0.1); color:var(--primary); border:none;">${insight['Market Demand']} Demand</span>
                        </div>
                        <div style="margin-bottom:0.75rem;">
                            <span style="font-size:0.7rem; color:var(--primary); font-weight:700; text-transform:uppercase;">Fundamental Concepts</span>
                            <div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.4rem;">
                                ${(insight['Fundamental Concepts'] || []).slice(0, 5).map(c => `<span style="font-size:0.7rem; background:rgba(255,255,255,0.05); padding:0.2rem 0.5rem; border-radius:4px; border:1px solid var(--border);">${c}</span>`).join('')}
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
                            <div>
                                <span style="font-size:0.7rem; color:var(--primary); font-weight:700; text-transform:uppercase;">Demand</span>
                                <p style="font-size:0.85rem; font-weight:600; line-height:1.2;">${insight['Market Demand'] || 'N/A'}</p>
                            </div>
                            <div>
                                <span style="font-size:0.7rem; color:var(--primary); font-weight:700; text-transform:uppercase;">Avg Salary</span>
                                <p style="font-size:0.85rem; font-weight:600;">${insight['Salary'] ? (typeof insight['Salary'] === 'string' ? insight['Salary'] : insight['Salary']['Entry']) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
                };

                const renderStats = (data, name) => {
                    const insight = getCourseInsight(data.brn);
                    return `
                <div style="background:var(--surface); padding:1.5rem; border-radius:12px; border:1px solid var(--border); display:flex; flex-direction:column;">
                    <h4 style="margin-bottom:0.25rem; font-size:1.1rem; color:var(--primary); line-height:1.4;">${name}</h4>
                    <p style="color:var(--text-muted); margin-bottom:1.5rem; font-size:0.9rem;">${data.brn} (${data.brc})</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem;">
                        ${categories.map(cat => `
                            <div style="display:flex; justify-content:space-between; padding:0.5rem; background:rgba(255,255,255,0.03); border-radius:6px;">
                                <span style="color:var(--text-muted); font-size:0.9rem;">${cat}</span>
                                <span style="font-weight:600; font-family:'Courier New'; color:var(--accent);">${data[cat] || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${renderCourseInfo(insight)}
                </div>
            `};

                res.innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:1.5rem; margin-top:2rem;">
                    ${renderStats(data1, c1)}
                    ${renderStats(data2, c2)}
                </div>
            `;
            }

            // --- Chat Bot Logic ---
            let chatState = {
                lastSubject: null // { type: 'course'|'college', name: string, data: any }
            };

            function toggleChat() {
                const win = document.getElementById('chatWindow');
                if (win.style.display === 'flex') {
                    win.style.display = 'none';
                    win.classList.remove('open');
                } else {
                    win.style.display = 'flex';
                    setTimeout(() => win.classList.add('open'), 10);
                    document.getElementById('chatInput').focus();
                }
            }

            function handleChatKey(e) {
                if (e.key === 'Enter') sendChatMessage();
            }

            function quickChat(msg) {
                document.getElementById('chatInput').value = msg;
                sendChatMessage();
            }

            function sendChatMessage() {
                const input = document.getElementById('chatInput');
                const msg = input.value.trim();
                if (!msg) return;

                addMessage(msg, 'user');
                input.value = '';

                // Show "Thinking" animation
                const indicator = document.getElementById('typingIndicator');
                indicator.style.display = 'block';
                const body = document.getElementById('chatBody');
                body.scrollTop = body.scrollHeight;

                // Simulate Bot Response with variable delay
                setTimeout(() => {
                    const response = getBotResponse(msg);
                    indicator.style.display = 'none';
                    addMessage(response, 'bot');
                }, 1000 + Math.random() * 1000); // 1-2 second delay
            }

            function addMessage(text, sender) {
                const body = document.getElementById('chatBody');
                const div = document.createElement('div');
                div.className = `message ${sender}`;
                div.innerHTML = text.replace(/\n/g, '<br>'); // Allow multiline

                // If it's the bot, we might want to insert it before the typing indicator
                const indicator = document.getElementById('typingIndicator');
                body.insertBefore(div, indicator);

                body.scrollTop = body.scrollHeight;
            }

            function getBotResponse(input) {
                const s = input.toLowerCase();

                // 1. Context Detection (Keywords/Intents)
                const isRanking = s.includes('rank') || s.includes('top') || s.includes('best');
                const isCourse = s.includes('course') || s.includes('branch') || s.includes('career') || s.includes('demand');
                const isCutoff = s.includes('cutoff') || s.includes('mark') || s.includes('score') || s.includes('get into') || s.includes('eligibl');
                const isFees = s.includes('fee') || s.includes('cost') || s.includes('price');
                const isFollowUp = s.includes('this') || s.includes('it') || s.includes('that') || s.includes('they') || s.includes('offer') || s.includes('which college');

                // 2. Intelligence: Ranking Queries
                if (isRanking) {
                    const foundRank = appState.rankings.find(r => s.includes(r.college.toLowerCase()));
                    if (foundRank) {
                        chatState.lastSubject = { type: 'college', name: foundRank.college, data: foundRank };
                        return `Yes! **${foundRank.college}** is one of the top-rated institutions. It currently holds a **NIRF Ranking of #${foundRank.ranking}**. It's known for its academic excellence and infrastructure.`;
                    }
                    if (isFollowUp && chatState.lastSubject && chatState.lastSubject.type === 'college') {
                        return `**${chatState.lastSubject.name}** is ranked **#${chatState.lastSubject.data.ranking}** in the NIRF 2024 rankings. Would you like to check its cutoffs?`;
                    }
                    if (s.includes('top') || s.includes('best')) {
                        const top3 = appState.rankings.slice(0, 3);
                        return `The top 3 engineering colleges in Tamil Nadu according to rankings are:\n1. ${top3[0]?.college}\n2. ${top3[1]?.college}\n3. ${top3[2]?.college}\nWould you like to know their cutoffs?`;
                    }
                }

                // 3. Intelligence: Course Details
                const courseInsight = appState.courseInsights.find(c => s.includes(c.name.toLowerCase()) || c.name.toLowerCase().includes(s.replace('tell me about', '').trim()));
                if (courseInsight && (isCourse || s.length < 30)) {
                    chatState.lastSubject = { type: 'course', name: courseInsight.name, data: courseInsight };
                    return `**${courseInsight.name}** is a great choice!\n\n**Market Demand:** ${courseInsight['Market Demand']}\n**Salary (Entry):** ${courseInsight.Salary?.Entry || 'Variable'}\n\n**Quick Summary:** ${courseInsight['Course Description'].substring(0, 150)}...\n\nShould I check which colleges offer this course?`;
                }

                // 4. Follow-up: Colleges for a Course
                if (isFollowUp && chatState.lastSubject && chatState.lastSubject.type === 'course') {
                    if (s.includes('college') || s.includes('offer') || s.includes('where') || s.includes('instit')) {
                        const searchName = chatState.lastSubject.name.toLowerCase();
                        const relevantColleges = appState.cutoffData2024.filter(c =>
                            c.brn.toLowerCase().includes(searchName) ||
                            c.brc.toLowerCase() === searchName
                        ).slice(0, 5);

                        if (relevantColleges.length > 0) {
                            const collegeNames = [...new Set(relevantColleges.map(c => c.con))];
                            return `Top colleges offering **${chatState.lastSubject.name}** include:\n${collegeNames.map(name => `- ${name}`).join('\n')}\n\nYou can see more details and full cutoffs for these in the 'Search Cutoffs' tab!`;
                        }
                    }
                }

                // 4. Intelligence: Cutoff Prediction (Score-based)
                const scoreMatch = s.match(/\d+(\.\d+)?/);
                if (isCutoff && scoreMatch) {
                    const score = parseFloat(scoreMatch[0]);
                    const colleges = appState.cutoffData2024.filter(c => parseFloat(c.OC) <= score).slice(0, 3);
                    if (colleges.length > 0) {
                        return `With a cutoff of **${score}**, you have a good chance at several institutions for OC category, including:\n${colleges.map(c => `- ${c.con} (${c.brn})`).join('\n')}\n\nI recommend using the **Course Predictor** tab for a full, personalized analysis!`;
                    } else {
                        return `A cutoff of **${score}** might be tight for the top-tier college branches, but there are many great colleges in the next tier. Try searching for specific branches in the 'Search Cutoffs' tab!`;
                    }
                }

                // 6. College Specific Queries
                const specificCollege = appState.cutoffData2024.find(c => s.includes(c.con.toLowerCase()));
                if (specificCollege && !isRanking) {
                    chatState.lastSubject = { type: 'college', name: specificCollege.con, data: specificCollege };
                    return `**${specificCollege.con}** is highly sought after. For **${specificCollege.brn}**, the typical cutoffs are quite high. You can view the full history for this college in the 'Search Cutoffs' tab by searching for "${specificCollege.con}".`;
                }

                // 6. Greetings & Fallbacks
                if (s.includes('hello') || s.includes('hi')) return "Hello! I'm your TNEA AI Assistant. I have access to rankings for 400+ colleges and detailed insights for 50+ courses. Ask me anything!";
                if (isFees) return "TNEA fees are regulated. Counseling costs â‚¹500 (Gen) / â‚¹250 (SC/ST). Semester fees for Govt colleges are around â‚¹10k-15k, while Private/Self-Financing colleges range from â‚¹50k to â‚¹1.5L+. Need more details?";

                return "I'm not exactly sure about that, but I can help you with college rankings, course career paths, or predicting your college based on your cutoff score. Try asking: 'What is the demand for AI?' or 'Best colleges for CSE'";
            }

            // --- Event Listeners ---
            document.getElementById('searchCollegeInput').addEventListener('input', () => { appState.currentPage = 1; renderCutoffTable(); });
            document.getElementById('categoryFilter').addEventListener('change', renderCutoffTable);
            document.getElementById('branchFilter').addEventListener('change', renderCutoffTable);
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    appState.year = e.target.dataset.year;
                    appState.currentPage = 1;
                    renderCutoffTable();
                });
            });

            document.getElementById('courseSearch').addEventListener('input', renderCourseInsights);
            document.getElementById('rankingSearch').addEventListener('input', renderRankings);

            // ===== College Predictor Logic =====
            let predictorState = {
                currentStep: 1,
                selectedBranches: []
            };

            function calcPredictorCutoff() {
                const m = parseFloat(document.getElementById('predMaths').value) || 0;
                const p = parseFloat(document.getElementById('predPhysics').value) || 0;
                const c = parseFloat(document.getElementById('predChemistry').value) || 0;
                const cutoff = m + (p / 2) + (c / 2);
                const display = document.getElementById('predCutoffScore');
                if (m === 0 && p === 0 && c === 0) {
                    display.textContent = 'â€”';
                } else {
                    display.textContent = cutoff.toFixed(2);
                }
            }

            function predNextStep(step) {
                // Validation for step 1 -> 2
                if (step === 2 && predictorState.currentStep === 1) {
                    const m = parseFloat(document.getElementById('predMaths').value);
                    const p = parseFloat(document.getElementById('predPhysics').value);
                    const c = parseFloat(document.getElementById('predChemistry').value);
                    if (isNaN(m) || isNaN(p) || isNaN(c) || m < 0 || p < 0 || c < 0 || m > 100 || p > 100 || c > 100) {
                        alert('Please enter valid marks (0-100) for Maths, Physics, and Chemistry.');
                        return;
                    }
                }
                predictorState.currentStep = step;
                updatePredictorUI();
            }

            // ===== Course Predictor Logic =====
            function updatePredictorUI() {
                // Update step visibility
                const step = predictorState.currentStep;
                document.querySelectorAll('.predictor-step').forEach(el => el.classList.remove('active'));
                const curentStepEl = document.getElementById('predStep' + step);
                if (curentStepEl) curentStepEl.classList.add('active');

                // Update progress indicators
                for (let i = 1; i <= 4; i++) {
                    const el = document.getElementById('pStep' + i);
                    if (el) {
                        el.classList.remove('active', 'completed');
                        if (i < step) el.classList.add('completed');
                        else if (i === step) el.classList.add('active');
                    }
                }

                // Update progress bar fill
                const pct = ((step - 1) / 3) * 100;
                const fill = document.getElementById('progressFill');
                if (fill) fill.style.width = pct + '%';

                // Populate branch discovery when entering step 3
                if (step === 3) {
                    const searchInput = document.getElementById('branchSearch');
                    if (searchInput) searchInput.value = '';
                    populateBranchDiscovery();
                }
            }

            function populateBranchDiscovery() {
                const container = document.getElementById('branchDiscoveryGrid');
                if (!container) return;

                const m = parseFloat(document.getElementById('predMaths').value) || 0;
                const p = parseFloat(document.getElementById('predPhysics').value) || 0;
                const c = parseFloat(document.getElementById('predChemistry').value) || 0;
                const cutoff = m + (p / 2) + (c / 2);
                const category = document.getElementById('predCategory').value;

                const branches = new Map();
                const data = appState.cutoffData2024;

                data.forEach(item => {
                    const branchCode = item.brc;
                    const branchName = item.brn;
                    const itemCutoff = parseFloat(item[category]);

                    if (!branches.has(branchCode)) {
                        branches.set(branchCode, {
                            code: branchCode,
                            name: branchName,
                            eligibleColleges: 0,
                            bestCollege: null,
                            bestCutoff: 0
                        });
                    }

                    if (!isNaN(itemCutoff) && itemCutoff <= cutoff) {
                        const b = branches.get(branchCode);
                        b.eligibleColleges++;
                        if (itemCutoff > b.bestCutoff) {
                            b.bestCutoff = itemCutoff;
                            b.bestCollege = item.con;
                        }
                    }
                });

                const branchArray = Array.from(branches.values())
                    .filter(b => b.eligibleColleges > 0)
                    .sort((a, b) => b.eligibleColleges - a.eligibleColleges);

                container.innerHTML = branchArray.map(b => {
                    const insight = appState.courseInsights.find(ci => ci.name === b.name || b.name.includes(ci.name));
                    const demand = insight ? insight['Market Demand'] : 'High';
                    const salary = insight ? (typeof insight['Salary'] === 'string' ? insight['Salary'] : insight['Salary']['Entry']) : 'N/A';
                    const isSelected = predictorState.selectedBranches.includes(b.code);
                    const isFav = isBranchFavorite(b.name); // Check if branch is favorite

                    return `
                    <div class="course-card ${isSelected ? 'selected' : ''}" 
                         style="cursor:pointer; border-color: ${isSelected ? 'var(--primary)' : 'var(--border)'}; border-width: ${isSelected ? '2px' : '1px'}" 
                         onclick="toggleBranchSelection(this, '${b.code}')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                            <span class="branch-code">${b.code}</span>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <button class="fav-btn ${isFav ? 'saved' : ''}" 
                                        onclick="event.stopPropagation(); toggleBranchFavorite('${b.name}'); this.classList.toggle('saved'); this.textContent = this.classList.contains('saved') ? 'â¤ï¸' : 'ðŸ¤';" 
                                        title="${isFav ? 'Remove from favorites' : 'Save to favorites'}"
                                        style="font-size:1.2rem; background:none; border:none; padding:0; cursor:pointer;">
                                    ${isFav ? 'â¤ï¸' : 'ðŸ¤'}
                                </button>
                                <button class="btn-icon" onclick="event.stopPropagation(); showCourseDetails('${b.name}')" title="Course Info">
                                    â„¹ï¸ Info
                                </button>
                                <span class="tag" style="background:rgba(16, 185, 129, 0.1); color:var(--success); border:none;">
                                    ${b.eligibleColleges} Col
                                </span>
                            </div>
                        </div>
                        <h3 style="font-size:1rem; margin-bottom:1rem;">${b.name}</h3>
                        
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">
                            <div style="margin-bottom:0.25rem;">ðŸ“Š Demand: <strong>${demand}</strong></div>
                            <div>ðŸ’° Avg Salary: <strong>${salary}</strong></div>
                        </div>

                        <div style="margin-top:auto; padding-top:0.75rem; border-top:1px solid var(--border); font-size:0.8rem;">
                            <div style="color:var(--primary); font-weight:600;">Best Avail:</div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${b.bestCollege}">${b.bestCollege}</div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function toggleBranchSelection(el, code) {
                el.classList.toggle('selected');
                if (predictorState.selectedBranches.includes(code)) {
                    predictorState.selectedBranches = predictorState.selectedBranches.filter(b => b !== code);
                    el.style.borderColor = 'var(--border)';
                    el.style.borderWidth = '1px';
                } else {
                    predictorState.selectedBranches.push(code);
                    el.style.borderColor = 'var(--primary)';
                    el.style.borderWidth = '2px';
                }
            }

            function filterBranchChips() {
                const term = document.getElementById('branchSearch').value.toLowerCase();
                const cards = document.querySelectorAll('#branchDiscoveryGrid .course-card');
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    if (text.includes(term)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }


            // ===== Course Details Modal Logic =====
            function showCourseDetails(branchName) {
                const modal = document.getElementById('courseDetailModal');
                const content = document.getElementById('courseModalContent');
                const favBtn = document.getElementById('favBranchBtn');

                // Find insight for this branch
                const insight = appState.courseInsights.find(ci => ci.name === branchName || branchName.includes(ci.name));

                if (!insight) {
                    content.innerHTML = `<p>No detailed information available for ${branchName}.</p>`;
                    favBtn.style.display = 'none';
                } else {
                    favBtn.style.display = 'block';
                    const features = insight['Key Features'] || [];
                    const featuresHtml = features.map(f => `<li class="feature-item">${f}</li>`).join('');

                    // Update favorite button state
                    const isFav = isBranchFavorite(insight.name);
                    favBtn.innerHTML = isFav ? 'â¤ï¸ Branch Saved' : 'ðŸ¤ Save Branch to Favorites';
                    favBtn.onclick = () => toggleBranchFavorite(insight.name);


                    // Find Related Courses (Simple logic: courses with same first word or "Engineering")
                    const relatedCourses = appState.courseInsights
                        .filter(ci => ci.name !== insight.name && (ci.name.includes(insight.name.split(' ')[0]) || (insight.name.includes('Eng') && ci.name.includes('Eng'))))
                        .slice(0, 3); // Take top 3

                    const relatedHtml = relatedCourses.length > 0
                        ? `<div class="info-section" >
                            <div class="info-label">Related Courses</div>
                            <div class="related-courses-list" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                ${relatedCourses.map(rc => `<span class="tag" style="cursor:pointer; background:var(--surface); border:1px solid var(--border);" onclick="showCourseDetails('${rc.name}')">${rc.name}</span>`).join('')}
                            </div>
                           </div> `
                        : '';

                    const roles = insight['Career Roles'] || insight['Job Positions'] || ['Various engineering roles in industry.'];
                    const rolesText = Array.isArray(roles) ? roles.join(', ') : roles;

                    content.innerHTML = `
                        <div class="modal-info-header" >
                        <div class="modal-info-title">${insight.name}</div>
                        <div class="tag" style="background:rgba(37,99,235,0.1); color:var(--primary); border:none;">${insight['Market Demand']} Demand</div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-label">Description</div>
                        <div class="info-content">${insight['Course Description']}</div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-label">Key Features & Specialties</div>
                        <ul class="feature-list">${featuresHtml}</ul>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-label">Career Opportunities</div>
                        <div class="info-content">${rolesText}</div>
                    </div>
                    
                    <div class="info-section" style="background:rgba(16,185,129,0.05); padding:1rem; border-radius:12px; border:1px solid rgba(16,185,129,0.1);">
                        <div class="info-label" style="color:var(--success)">Salary Range</div>
                        <div class="info-content" style="font-weight:600; font-size:1.1rem; color:var(--success)">
                            ${typeof insight['Salary'] === 'string' ? insight['Salary'] : (insight['Salary'].Entry + ' to ' + (insight['Salary'].Experienced || insight['Salary'].Senior))}
                        </div>
                    </div>

                    ${relatedHtml}
                    `;
                }

                modal.classList.remove('hidden');
            }

            function closeCourseModal() {
                document.getElementById('courseDetailModal').classList.add('hidden');
            }

            function runPredictor() {
                const maths = parseFloat(document.getElementById('predMaths').value) || 0;
                const physics = parseFloat(document.getElementById('predPhysics').value) || 0;
                const chemistry = parseFloat(document.getElementById('predChemistry').value) || 0;
                const cutoff = maths + (physics / 2) + (chemistry / 2);
                const category = document.getElementById('predCategory').value;
                const studentName = document.getElementById('predName').value || 'Student';
                const selectedBranches = predictorState.selectedBranches;
                const maxResults = parseInt(document.getElementById('predResultCount').value) || 50;

                // Filter matching colleges
                let matches = appState.cutoffData2024.filter(item => {
                    const collegeCutoff = parseFloat(item[category]);
                    if (isNaN(collegeCutoff) || collegeCutoff <= 0) return false;

                    // Student's cutoff must be >= the college cutoff for that category
                    if (cutoff < collegeCutoff) return false;

                    // Filter by preferred branches if selected
                    if (selectedBranches.length > 0 && !selectedBranches.includes(item.brc)) return false;

                    return true;
                });

                // Add NIRF ranking info to matches
                matches = matches.map(item => {
                    const rankInfo = appState.rankings.find(r => {
                        const rName = r.college.toLowerCase().trim();
                        const iName = item.con.toLowerCase().trim();
                        return rName.includes(iName.substring(0, 30)) || iName.includes(rName.substring(0, 30));
                    });
                    return {
                        ...item,
                        nirfRank: rankInfo ? rankInfo.ranking : null,
                        nirfRankNum: rankInfo ? (typeof rankInfo.ranking === 'number' ? rankInfo.ranking : parseInt(rankInfo.ranking) || 999) : 999,
                        margin: (cutoff - parseFloat(item[category])).toFixed(2)
                    };
                });

                // Sort: NIRF rank first, then by cutoff (higher cutoff = more competitive = better)
                matches.sort((a, b) => {
                    if (a.nirfRankNum !== b.nirfRankNum) return a.nirfRankNum - b.nirfRankNum;
                    return parseFloat(b[category]) - parseFloat(a[category]);
                });

                // Categorize into tiers
                const dreamColleges = []; // margin < 5 (competitive)
                const reachColleges = []; // margin 5-20
                const safeColleges = []; // margin > 20

                matches.forEach(m => {
                    const margin = parseFloat(m.margin);
                    if (margin < 5) dreamColleges.push(m);
                    else if (margin <= 20) reachColleges.push(m);
                    else safeColleges.push(m);
                });

                // Get unique branches and colleges count
                const uniqueColleges = new Set(matches.map(m => m.con)).size;
                const uniqueBranches = new Set(matches.map(m => m.brc)).size;

                // Render results
                const resultsDiv = document.getElementById('predictorResults');

                if (matches.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="no-results-msg" >
                <div class="emoji">ðŸ˜”</div>
                <h3>No matching colleges found</h3>
                <p>Your cutoff mark (${cutoff.toFixed(2)}) for ${category} category didn't match any colleges in our 2024 data.</p>
                <p>Try selecting different branches or check if your marks are entered correctly.</p>
            </div>
                        `;
                    predNextStep(4);
                    return;
                }

                const renderSuggestionCard = (item) => {
                    const favKey = `${item.con}|| ${item.brc} `;
                    const isSaved = isFavorite(favKey);
                    const safeItem = JSON.stringify({
                        con: item.con,
                        brc: item.brc,
                        brn: item.brn,
                        OC: item.OC || '',
                        BC: item.BC || '',
                        BCM: item.BCM || '',
                        MBC: item.MBC || '',
                        SC: item.SC || '',
                        SCA: item.SCA || '',
                        ST: item.ST || ''
                    }).replace(/"/g, '&quot;');
                    return `
                        <div class="suggestion-card" >
            <div class="suggestion-info">
                <div class="college-name">${item.con}</div>
                <div class="branch-name">${item.brc} - ${item.brn}</div>
            </div>
            <div class="suggestion-meta">
                <div class="meta-badge cutoff-badge">${item[category]}</div>
                ${item.nirfRank ? `<div class="meta-badge rank-badge-tag">#${item.nirfRank}</div>` : ''}
                <button class="fav-btn ${isSaved ? 'saved' : ''}" onclick="toggleFavoriteFromPredictor('${favKey.replace(/'/g, "\\'")}', '${safeItem}', this)" title="${isSaved ? 'Remove from favorites' : 'Save to favorites'}">${isSaved ? 'â¤ï¸' : 'ðŸ¤'}</button>
            </div>
        </div>
                        `};

                const renderTier = (title, emoji, tierClass, items, limit) => {
                    if (items.length === 0) return '';
                    const shown = items.slice(0, limit);
                    return `
                        <div class="results-section-title" > ${emoji} ${title} <span style="font-size:0.8rem;color:var(--text-muted);font-weight:400">(${items.length} options)</span></div>
                            <div class="tier-label ${tierClass}">${tierClass === 'dream' ? 'Competitive - margin < 5' : tierClass === 'reach' ? 'Good Chance - margin 5-20' : 'Safe - margin > 20'}</div>
            ${shown.map(renderSuggestionCard).join('')}
            ${items.length > limit ? `<p style="text-align:center;color:var(--text-muted);font-size:0.85rem;margin:0.5rem 0;">... and ${items.length - limit} more</p>` : ''}
                    `;
                };

                const summaryHtml = `
                        <div class="results-summary" >
            <div class="result-stat">
                <div class="result-num">${matches.length}</div>
                <div class="result-label">Total Options</div>
            </div>
            <div class="result-stat">
                <div class="result-num">${uniqueColleges}</div>
                <div class="result-label">Colleges</div>
            </div>
            <div class="result-stat">
                <div class="result-num">${uniqueBranches}</div>
                <div class="result-label">Branches</div>
            </div>
        </div>
                        `;

                resultsDiv.innerHTML = summaryHtml +
                    renderTier('Dream Choices', 'âœ¨', 'dream', dreamColleges, 15) +
                    renderTier('Reach Choices', 'ðŸŽ¯', 'reach', reachColleges, 15) +
                    renderTier('Safe Options', 'âœ…', 'safe', safeColleges, 15);

                predNextStep(4);
            }

            function printResults() {
                window.print();
            }

            // ===== Login / Auth System =====
            let authState = {
                isLoggedIn: false,
                user: null,
                isRegisterMode: false
            };

            function initAuth() {
                const savedUser = localStorage.getItem('tnea_current_user');
                if (savedUser) {
                    authState.isLoggedIn = true;
                    authState.user = JSON.parse(savedUser);
                }
                renderUserArea();
                updateFavBadge();
            }

            function renderUserArea() {
                const area = document.getElementById('userArea');
                if (authState.isLoggedIn && authState.user) {
                    const initials = authState.user.name ? authState.user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'U';
                    area.innerHTML = `
                        <div class="user-area">
                        <div class="user-avatar">${initials}</div>
                        <span class="user-name">${authState.user.name || authState.user.username}</span>
                        <button class="logout-btn" onclick="handleLogout()">Logout</button>
                    </div>
                        `;

                    // Update Hero Greeting
                    const heroG = document.getElementById('heroGreetingContainer');
                    if (heroG) {
                        heroG.innerHTML = `<div class="hero-greeting">Welcome, ${authState.user.name || authState.user.username} ðŸ‘‹</div>`;
                    }
                } else {
                    area.innerHTML = `<button class="login-nav-btn" onclick="showLoginModal()">ðŸ” Login</button>`;
                    const heroG = document.getElementById('heroGreetingContainer');
                    if (heroG) heroG.innerHTML = '';
                }
            }

            function showLoginModal() {
                // Ensure we always start in Login mode
                if (authState.isRegisterMode) toggleLoginMode();

                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('loginUsername').focus();
                document.getElementById('loginError').style.display = 'none';
            }

            function closeLoginModal() {
                document.getElementById('loginModal').classList.add('hidden');
            }

            function toggleLoginMode() {
                authState.isRegisterMode = !authState.isRegisterMode;
                const title = document.getElementById('loginModalTitle');
                const subtitle = document.getElementById('loginModalSubtitle');
                const btn = document.getElementById('loginSubmitBtn');
                const toggleText = document.getElementById('toggleText');
                const toggleLink = document.getElementById('toggleLink');
                const nameGroup = document.getElementById('loginNameGroup');
                const forgotPwd = document.getElementById('forgotPwdWrapper');
                const error = document.getElementById('loginError');
                error.style.display = 'none';

                if (authState.isRegisterMode) {
                    title.textContent = 'Create Account';
                    subtitle.textContent = 'Register to save your favorite colleges';
                    btn.textContent = 'Register';
                    toggleText.textContent = 'Already have an account? ';
                    toggleLink.textContent = 'Login';
                    nameGroup.style.display = 'block';
                    forgotPwd.style.display = 'none';
                } else {
                    title.textContent = 'Welcome Back';
                    subtitle.textContent = 'Login to save your favorite colleges';
                    btn.textContent = 'Login';
                    toggleText.textContent = "Don't have an account? ";
                    toggleLink.textContent = 'Register';
                    nameGroup.style.display = 'none';
                    forgotPwd.style.display = 'flex';
                }
            }

            function handleLogin() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                const error = document.getElementById('loginError');

                if (!username || !password) {
                    error.textContent = 'Please enter both username and password.';
                    error.style.display = 'block';
                    return;
                }

                if (username.length < 3) {
                    error.textContent = 'Username must be at least 3 characters.';
                    error.style.display = 'block';
                    return;
                }

                // Get stored users
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');

                if (authState.isRegisterMode) {
                    // REGISTER
                    if (users[username]) {
                        error.innerHTML = `Username already exists. <a href = "#" onclick = "toggleLoginMode()" style = "color:inherit; text-decoration:underline;" > Click here to Login instead.</a> `;
                        error.style.display = 'block';
                        return;
                    }
                    const fullName = document.getElementById('loginFullName').value.trim() || username;
                    users[username] = { password: password, name: fullName, favorites: [], favoriteBranches: [] };
                    localStorage.setItem('tnea_users', JSON.stringify(users));

                    authState.isLoggedIn = true;
                    authState.user = { username, name: fullName };
                    localStorage.setItem('tnea_current_user', JSON.stringify(authState.user));
                } else {
                    // LOGIN
                    if (!users[username]) {
                        error.innerHTML = `User not found. <a href = "#" onclick = "toggleLoginMode()" style = "color:inherit; text-decoration:underline;" > Click here to Create an Account.</a> `;
                        error.style.display = 'block';
                        return;
                    }
                    if (users[username].password !== password) {
                        error.textContent = 'Incorrect password. Please try again.';
                        error.style.display = 'block';
                        return;
                    }
                    authState.isLoggedIn = true;
                    authState.user = { username, name: users[username].name };
                    localStorage.setItem('tnea_current_user', JSON.stringify(authState.user));
                }

                closeLoginModal();
                renderUserArea();
                updateFavBadge();
                renderCutoffTable();
                // Clear form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginFullName').value = '';
            }

            function handleLogout() {
                authState.isLoggedIn = false;
                authState.user = null;
                localStorage.removeItem('tnea_current_user');
                renderUserArea();
                updateFavBadge();
                renderCutoffTable();
            }

            function handleGoogleLogin() {
                // Simulate Google Sign-In
                const googleUsers = [
                    { username: 'google_user', name: 'Google User' },
                    { username: 'sweety_google', name: 'Sweety Jerome' }
                ];
                const user = googleUsers[1]; // Use a mock user

                authState.isLoggedIn = true;
                authState.user = user;
                localStorage.setItem('tnea_current_user', JSON.stringify(user));

                // Ensure user exists in storage
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                if (!users[user.username]) {
                    users[user.username] = { password: 'google_oauth_protected', name: user.name, favorites: [], favoriteBranches: [] };
                    localStorage.setItem('tnea_users', JSON.stringify(users));
                }

                closeLoginModal();
                renderUserArea();
                updateFavBadge();
                renderCutoffTable();

                alert(`Successfully signed in with Google as ${user.name} !`);
            }

            function handleForgotPassword() {
                const username = document.getElementById('loginUsername').value.trim();
                const error = document.getElementById('loginError');

                if (!username) {
                    error.textContent = 'Please enter your username first to reset password.';
                    error.style.display = 'block';
                    return;
                }

                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                if (!users[username]) {
                    error.textContent = 'Username not found.';
                    error.style.display = 'block';
                    return;
                }

                // In a real app, you'd send an email. Here we just show a "reset" alert
                // or tell them their password for this local-only demo.
                alert(`[Local Demo Only] Password for ${username} is: ${users[username].password} \n\nIn a live production app, a reset link would be sent to your email.`);
            }

            // ===== Favorites System =====
            function getFavorites() {
                if (!authState.isLoggedIn || !authState.user) return [];
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                const u = users[authState.user.username];
                return u ? (u.favorites || []) : [];
            }

            function saveFavorites(favs) {
                if (!authState.isLoggedIn || !authState.user) return;
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                if (users[authState.user.username]) {
                    users[authState.user.username].favorites = favs;
                    localStorage.setItem('tnea_users', JSON.stringify(users));
                }
            }

            function isFavorite(key) {
                const favs = getFavorites();
                return favs.some(f => f.key === key);
            }

            function toggleFavorite(key, btnEl, itemData) {
                if (!authState.isLoggedIn) {
                    showLoginModal();
                    return;
                }
                let favs = getFavorites();
                const exists = favs.findIndex(f => f.key === key);
                if (exists >= 0) {
                    favs.splice(exists, 1);
                    if (btnEl) {
                        btnEl.classList.remove('saved');
                        btnEl.textContent = 'ðŸ¤';
                        btnEl.title = 'Save to favorites';
                    }
                } else {
                    favs.push({
                        key: key,
                        con: itemData.con,
                        brc: itemData.brc,
                        brn: itemData.brn,
                        OC: itemData.OC,
                        BC: itemData.BC,
                        BCM: itemData.BCM,
                        MBC: itemData.MBC,
                        SC: itemData.SC,
                        SCA: itemData.SCA,
                        ST: itemData.ST,
                        savedAt: new Date().toISOString()
                    });
                    if (btnEl) {
                        btnEl.classList.add('saved');
                        btnEl.textContent = 'â¤ï¸';
                        btnEl.title = 'Remove from favorites';
                    }
                }
                saveFavorites(favs);
                updateFavBadge();
            }

            function toggleFavoriteFromPredictor(key, itemJSON, btnEl) {
                const itemData = JSON.parse(itemJSON);
                toggleFavorite(key, btnEl, itemData);
            }

            function removeFavorite(key) {
                let favs = getFavorites();
                favs = favs.filter(f => f.key !== key);
                saveFavorites(favs);
                updateFavBadge();
                renderFavorites();
                renderCutoffTable();
            }

            // Branch Favorites logic
            function getFavoriteBranches() {
                if (!authState.isLoggedIn || !authState.user) return [];
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                const u = users[authState.user.username];
                return u ? (u.favoriteBranches || []) : [];
            }

            function isBranchFavorite(name) {
                return getFavoriteBranches().includes(name);
            }

            function toggleBranchFavorite(name, btnEl) {
                if (!authState.isLoggedIn) {
                    closeCourseModal();
                    showLoginModal();
                    return;
                }
                const users = JSON.parse(localStorage.getItem('tnea_users') || '{}');
                const u = users[authState.user.username];
                if (!u) return;

                if (!u.favoriteBranches) u.favoriteBranches = [];
                const idx = u.favoriteBranches.indexOf(name);
                if (idx >= 0) {
                    u.favoriteBranches.splice(idx, 1);
                } else {
                    u.favoriteBranches.push(name);
                }
                localStorage.setItem('tnea_users', JSON.stringify(users));

                // Refresh UI
                if (btnEl) {
                    const isFav = isBranchFavorite(name);
                    btnEl.innerHTML = isFav ? 'â¤ï¸' : 'ðŸ¤';
                    btnEl.classList.toggle('saved', isFav);
                }

                // Also update the modal button if it exists
                const modalFavBtn = document.getElementById('favBranchBtn');
                if (modalFavBtn) {
                    const isFav = isBranchFavorite(name);
                    modalFavBtn.innerHTML = isFav ? 'â¤ï¸ Branch Saved' : 'ðŸ¤ Save Branch to Favorites';
                }

                updateFavBadge();
                if (appState.currentPageTab === 'favorites') renderFavorites();
            }

            function updateFavBadge() {
                const badge = document.getElementById('favCountBadge');
                const favs = getFavorites();
                const branchFavs = getFavoriteBranches();
                const total = favs.length + branchFavs.length;
                if (total > 0) {
                    badge.textContent = total;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }

            function renderFavorites() {
                const container = document.getElementById('favoritesList');

                if (!authState.isLoggedIn) {
                    container.innerHTML = `
                        <div class="fav-empty" >
                        <div class="fav-empty-icon">ðŸ”</div>
                        <h3>Login Required</h3>
                        <p style="margin-bottom:1rem;">Please login to view and save your favorite colleges.</p>
                        <button class="btn-primary" onclick="showLoginModal()" style="display:inline-block;">Login / Register</button>
                    </div>
                        `;
                    return;
                }

                const favs = getFavorites();
                const branchFavs = getFavoriteBranches();

                if (favs.length === 0 && branchFavs.length === 0) {
                    container.innerHTML = `
                        <div class="fav-empty" >
                        <div class="fav-empty-icon">ðŸ’”</div>
                        <h3>No favorites yet</h3>
                        <p>Go to Search Cutoffs or Course Predictor and click the â¤ï¸ button to save colleges or courses here.</p>
                    </div>
                        `;
                    return;
                }

                let html = '';
                if (branchFavs.length > 0) {
                    html += `
                        <h3 style = "margin:2rem 0 1rem; color:var(--primary);" >â­ï¸ Favorite Courses</h3>
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-bottom:2rem;">
                                ${branchFavs.map(name => {
                        const insight = appState.courseInsights.find(ci => ci.name === name);
                        return `
                            <div class="fav-card" style="border-left:4px solid var(--accent);">
                                <div class="fav-info">
                                    <div class="fav-college" style="font-size:1.1rem;">${name}</div>
                                    <div class="fav-branch">${insight ? insight['Market Demand'] : 'High'} Demand Course</div>
                                </div>
                                <button class="remove-fav-btn" onclick="toggleBranchFavorite('${name}')">ðŸ—‘ï¸ Remove</button>
                            </div>
                            `;
                    }).join('')}
                            </div>
                    `;
                }

                if (favs.length > 0) {
                    html += `
                        <h3 style = "margin:2rem 0 1rem; color:var(--primary);" >ðŸ“ Favorite Colleges</h3>
                            <p style="color:var(--text-muted); margin-bottom:1rem;">You have <strong style="color:var(--primary)">${favs.length}</strong> saved college(s)</p>
                    ${favs.map(f => `
                        <div class="fav-card">
                            <div class="fav-info">
                                <div class="fav-college">${f.con}</div>
                                <div class="fav-branch">${f.brc} - ${f.brn}</div>
                                <div class="fav-cutoffs">
                                    ${f.OC ? `<span class="fav-cutoff-tag">OC: ${f.OC}</span>` : ''}
                                    ${f.BC ? `<span class="fav-cutoff-tag">BC: ${f.BC}</span>` : ''}
                                    ${f.BCM ? `<span class="fav-cutoff-tag">BCM: ${f.BCM}</span>` : ''}
                                    ${f.MBC ? `<span class="fav-cutoff-tag">MBC: ${f.MBC}</span>` : ''}
                                    ${f.SC ? `<span class="fav-cutoff-tag">SC: ${f.SC}</span>` : ''}
                                </div>
                            </div>
                            <button class="remove-fav-btn" onclick="removeFavorite('${f.key.replace(/'/g, "\\'")}')">ðŸ—‘ï¸ Remove</button>
                        </div>
                    `).join('')
                        }
                    `;
                }
                container.innerHTML = html;
            }

            // Override switchTab to also render favorites
            const originalSwitchTab = switchTab;
            switchTab = function (tabId) {
                originalSwitchTab(tabId);
                if (tabId === 'favorites') {
                    renderFavorites();
                }
                if (tabId === 'assessment' && currentAssessment.history.length === 0) {
                    startAssessment();
                }
            };

            function initApp() {
                initAuth();
                loadData();
                updateFavBadge();
            }

            window.addEventListener('load', initApp);

            // Responsive Navbar Scroll Effect
            window.addEventListener('scroll', () => {
                const nav = document.querySelector('.navbar');
                if (window.scrollY > 50) {
                    nav.style.background = 'rgba(255, 255, 255, 0.95)';
                    nav.style.boxShadow = '0 5px 20px rgba(0,0,0,0.05)';
                } else {
                    nav.style.background = 'rgba(255, 255, 255, 0.9)';
                    nav.style.boxShadow = 'none';
                }
            });

            // ===== Assessment System =====
            const branchMapping = {
                cs: {
                    name: "Computer Science (Coding & Apps)",
                    tags: ["Software", "Apps", "Websites"],
                    desc: "It's all about telling computers what to do. You'll learn to build apps, games, and websites.",
                    future: "Every company needs software now. You will be the one building the tools everyone uses.",
                    career: "App Developer, Web Creator, Software Engineer, Data Analyst.",
                    suitability: "Great if you like solving puzzles and logic games.",
                    pros: ["Good starting salary", "Can work from anywhere", "Always plenty of jobs"],
                    cons: ["Sitting for long hours", "Need to keep learning new things", "Fast-paced work"]
                },
                it: {
                    name: "Information Technology (Systems & Web)",
                    tags: ["Web", "Security", "Data"],
                    desc: "Focuses on making sure computer systems and networks work smoothly for businesses.",
                    future: "The world runs on the internet. You'll keep the digital world connected and safe.",
                    career: "Network Manager, IT Support, Web Architect, Security Specialist.",
                    suitability: "Perfect if you like organizing things and fixing tech problems.",
                    pros: ["Jobs in every type of company", "Practical skills", "Steady career"],
                    cons: ["Can be repetitive", "Sometimes work odd hours", "Lots of screen time"]
                },
                ai: {
                    name: "AI & Data Science (Smart Machines)",
                    tags: ["ChatGPT", "Robots", "Data"],
                    desc: "Teach computers to think! Learn how things like ChatGPT, face ID, and recommendations work.",
                    future: "AI is the new electricity. You'll helping build the smart future.",
                    career: "AI Developer, Data Scientist, Machine Learning Engineer.",
                    suitability: "If you are curious about how 'Siri' or 'Google' actually knows the answers.",
                    pros: ["Very high demand", "Exciting new field", "High pay potential"],
                    cons: ["Requires good math skills", "Complex to learn initially", "Always changing"]
                },
                ec: {
                    name: "Electronics & Communication (Chips & 5G)",
                    tags: ["Chips", "Signals", "5G"],
                    desc: "Understand what's inside your phone and how Wi-Fi travels through the air.",
                    future: "From faster internet (6G) to smarter gadgets, you'll build the hardware of the future.",
                    career: "Chip Designer, IoT Engineer, Network Engineer, Telecom Expert.",
                    suitability: "If you wonder how gadgets work and like combining hardware with software.",
                    pros: ["Work with real devices", "Core engineering job", "Good for R&D"],
                    cons: ["Harder subjects", "Need to be very precise", "Slower initial growth than IT"]
                },
                ee: {
                    name: "Electrical & Electronics (Power & EVs)",
                    tags: ["Electric Cars", "Solar", "Power"],
                    desc: "Power the world! Learn about electricity, huge motors, and Electric Vehicles.",
                    future: "The world is going Electric. You'll build the chargers, batteries, and grids of tomorrow.",
                    career: "EV Engineer, Power Grid Manager, Solar Energy Expert.",
                    suitability: "If you want to work on big energy systems or green technology.",
                    pros: ["Green & Sustainable career", "Real physical results", "Many Government jobs"],
                    cons: ["Working with high voltage", "Field work (outdoors)", "Physically active"]
                },
                mech: {
                    name: "Mechanical Engineering (Machines & Robots)",
                    tags: ["Cars", "Robots", "Engines"],
                    desc: "Design and build anything that movesâ€”from racing cars to giant robots.",
                    future: "Robots are taking over factories. You'll design the machines of the future.",
                    career: "Car Designer, Robotics Engineer, Aerospace Specialist.",
                    suitability: "If you love taking things apart to see how they work.",
                    pros: ["Very versatile degree", "Basis for robotics/EVs", "High job satisfaction"],
                    cons: ["Factory environment", "Heavy subjects", "Lower starting pay"]
                },
                civil: {
                    name: "Civil Engineering (Buildings & Cities)",
                    tags: ["Skyscrapers", "Bridges", "Cities"],
                    desc: "Build the world around us. Design skyscrapers, bridges, and smart cities.",
                    future: "We need smarter, greener cities. You'll design where people live and work.",
                    career: "Structural Designer, Site Manager, Urban Planner.",
                    suitability: "If you want to see your drawings turn into real, standing structures.",
                    pros: ["Leave a physical legacy", "Good for business", "Outdoor work"],
                    cons: ["Long project times", "Lots of rules/safety", "Weather-dependent"]
                },
                cyber: {
                    name: "Cyber Security (Digital Police)",
                    tags: ["Hackers", "Security", "Privacy"],
                    desc: "Be a digital detective. Protect people and banks from hackers and thieves.",
                    future: "As we go digital, safety is #1. You'll be the protector of the internet.",
                    career: "Ethical Hacker, Security Analyst, Privacy Officer.",
                    suitability: "If you are naturally suspicious and love finding loopholes.",
                    pros: ["Huge demand", "Exciting 'Detective' work", "High respect"],
                    cons: ["High stress", "Constant battle", "Always on alert"]
                },
                agri: {
                    name: "Agricultural Engineering (Smart Farming)",
                    tags: ["Farming", "Drones", "Water"],
                    desc: "Use technology to grow better food! Design drones and smart watering systems for farms.",
                    future: "We need more food for the world. You'll use tech to make farming easier and greener.",
                    career: "Smart Farm Manager, Agri-Tech Designer, Food Process Engineer.",
                    suitability: "If you love nature and want to use tech to help farmers and the planet.",
                    pros: ["High societal impact", "Combining nature with tech", "Unique career niche"],
                    cons: ["Lots of rural/village travel", "Seasonal work cycles", "Niche industry"]
                },
                robot: {
                    name: "Robotics & Automation (Future Workers)",
                    tags: ["Robots", "Sensors", "AI"],
                    desc: "Build machines that can move and think on their own! From factory arms to surgical robots.",
                    future: "Robots will do all the hard work. You'll be the one commanding them.",
                    career: "Robotics Designer, Automation Analyst, Control System Architect.",
                    suitability: "If you love sci-fi movies and want to make 'real' robots, pick this.",
                    pros: ["Cutting-edge innovation", "Extremely fun to build", "Fast growing field"],
                    cons: ["Requires deep multi-skill knowledge", "Expensive to build prototypes", "Intense learning curve"]
                },
                aero: {
                    name: "Aerospace Engineering (Planes & Space)",
                    tags: ["Rockets", "Planes", "Space"],
                    desc: "Design machines that fly! From fast jets to rockets going to Mars.",
                    future: "With private space companies rising, you could be building the first Mars colony.",
                    career: "Rocket Scientist, Aircraft Designer, Satellite Engineer.",
                    suitability: "If you've always looked at the stars or planes with wonder.",
                    pros: ["High prestige/Respect", "Work on space missions", "Elite engineering field"],
                    cons: ["Hardest math & physics", "Very high safety pressure", "Limited number of companies"]
                },
                biomed: {
                    name: "Biomedical Engineering (Health Tech)",
                    tags: ["Hospitals", "Gadgets", "Scanners"],
                    desc: "Dignity in technology! Design machines that save lives, like MRI scanners or bionic limbs.",
                    future: "Healthcare is going high-tech. You'll be the bridge between doctors and engineers.",
                    career: "Medical Device Designer, Health-Tech Consultant, Lab Instrument Expert.",
                    suitability: "If you want to help people and love biology along with machines.",
                    pros: ["Save lives with tech", "Fast growing health sector", "Meaningful work"],
                    cons: ["Strict hospital regulations", "Requires deep biology learning", "Complex safety testing"]
                },
                chem: {
                    name: "Chemical Engineering (Medicine & Fuels)",
                    tags: ["Medicines", "Fuels", "Perfumes"],
                    desc: "Transform raw materials into cool things like medicines, fuels, or even your favorite perfumes.",
                    future: "Sustainability and new materials are the key. You'll find cleaner ways to make products.",
                    career: "Medicine Maker, Energy Researcher, Material Scientist.",
                    suitability: "If you love chemistry labs and wondering how things are made in factories.",
                    pros: ["Critical for medicines/pharma", "Very high pay in energy sector", "Versatile knowledge"],
                    cons: ["Exposure to chemicals", "Strict safety gear needed", "Usually working in industrial zones"]
                },
                fashion: {
                    name: "Fashion Technology (Tech & Style)",
                    tags: ["Clothes", "Design", "Fabrics"],
                    desc: "Engineering for the style world! Combine high-tech fabrics with modern apparel design.",
                    future: "Smart clothes that track your health are coming. You'll design the future of style.",
                    career: "Apparel Designer, Textile Technologist, Fashion Brand Lead.",
                    suitability: "If you have style and want to use math and logic to make clothes better.",
                    pros: ["Creative & Logical mix", "Work in the fashion world", "Tangible everyday products"],
                    cons: ["Fast changing trends", "High competition", "Industrial factory visits"]
                },
                textile: {
                    name: "Textile Technology (Smart Fabrics)",
                    tags: ["Cloth", "Looms", "Colors"],
                    desc: "Learn how the clothes you wear are made, from cotton to high-tech threads.",
                    future: "Eco-friendly fabrics are the big goal. You'll make the world more sustainable through cloth.",
                    career: "Quality Control Lead, Textile Engineer, Sustainability Expert.",
                    suitability: "If you are interested in the massive industry that covers the world.",
                    pros: ["Huge global industry", "Core human necessity", "Many jobs in industrial hubs"],
                    cons: ["Traditional industry", "Factory-based work", "Loud environments"]
                },
                food: {
                    name: "Food Technology (Tasty Science)",
                    tags: ["Food", "Safety", "Nutrition"],
                    desc: "How do chips stay crunchy? How is ice cream made? Learn the science of the food you eat.",
                    future: "Making healthy, long-lasting food for billions of people is a huge challenge.",
                    career: "Food Quality Officer, Product Developer, Nutrition Analyst.",
                    suitability: "If you love food and are curious about what's listed on the back of the packet.",
                    pros: ["Recession-proof job (people always eat!)", "Creative product making", "Great for entrepreneurship"],
                    cons: ["Lots of food safety checks", "Standing in labs/factories", "Requires high hygiene"]
                },
                petro: {
                    name: "Petrochemicals (Fuel & Energy)",
                    tags: ["Energy", "Refineries", "Oil"],
                    desc: "Work with the energy that powers our world. Focus on oil, gas, and plastics.",
                    future: "Transitioning to cleaner energy from traditional oil is the next big challenge.",
                    career: "Refinery Engineer, Energy Analyst, Process Specialist.",
                    suitability: "If you want to work in a massive, high-stakes energy industry.",
                    pros: ["Highest salary potential", "International travel", "Deep technical learning"],
                    cons: ["Remote plant locations", "Challenging safety rules", "Work can be in harsh weather"]
                },
                auto: {
                    name: "Automobile Engineering (Cars & Bikes)",
                    tags: ["Supercars", "Racing", "Engines"],
                    desc: "Build the next sports car or superbike! Focus on design, speed, and safety.",
                    future: "Driverless cars and flying vehicles are coming. You'll be the one designing them.",
                    career: "Car Designer, Racing Analyst, Safety Engineer.",
                    suitability: "If you're a 'gearhead' who loves bikes and cars more than anything.",
                    pros: ["Work with your passion", "Thrilling field", "Focus on speed/cool design"],
                    cons: ["High pressure for safety", "Expensive parts", "Shift to electric changing everything"]
                },
                env: {
                    name: "Environmental Engineering (Planet Saving)",
                    tags: ["Water", "Green", "Earth"],
                    desc: "Save the Earth! Design systems to clean water, reduce pollution, and stop climate change.",
                    future: "The Earth needs you. Sustainable living is not a choice, it's a necessity.",
                    career: "Pollution Control Officer, Sustainability Expert, Water Project Designer.",
                    suitability: "If you're a nature lover who wants to use science to fix the planet.",
                    pros: ["Most meaningful career", "Global opportunities", "Highly respected work"],
                    cons: ["Lots of rules & laws", "Can be difficult to see progress", "Government-focused jobs"]
                },
                prod: {
                    name: "Production (The Factory Maestro)",
                    tags: ["Efficiency", "Factories", "Management"],
                    desc: "The 'Boss' of the factory! Optimize how things are made and delivered efficiently.",
                    future: "Smart factories (Industry 4.0) need managers who understand both machines and people.",
                    career: "Industrial Manager, Supply Chain Consultant, Quality Control Lead.",
                    suitability: "If you are very organized and love making systems faster and better.",
                    pros: ["Great bridge to Management (MBA)", "See the big picture", "Wide job options"],
                    cons: ["High stress environment", "24/7 factory cycles", "Metrics & target pressure"]
                }
            };


            let currentAssessment = {
                mode: 'discovery', // 'discovery', 'comparison', or 'goal'
                goal: null, // selected goal branch key
                selectedCompareBranches: [],
                academic: {
                    group: 'math',
                    marks: { math: 0, physics: 0, chem: 0, cs: 0, overall: 0 }
                },
                quizIndex: 0,
                quizScores: {},
                quizRef: [], // Store personalized strings for results
                history: [] // Stack of screen IDs for back navigation
            };

            const assessmentQuestions = [
                {
                    text: "When solving a problem, you like to:",
                    desc: "Choose the method that feels most natural to you.",
                    options: [
                        { text: "Use computer and think logically", ref: "you enjoy logical problem solving on computers", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Work with tools or machines", ref: "you have a knack for machines and tools", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Design buildings or plans", ref: "you are a natural designer of physical structures", score: { civil: 15, env: 12, agri: 10 } },
                        { text: "Study and analyze deeply", ref: "you thrive on deep analysis and systems", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "In school, you enjoyed:",
                    desc: "Recall your favorite hands-on memories.",
                    options: [
                        { text: "Computer lab", ref: "you were a star in the computer lab", score: { cs: 15, it: 15, cyber: 10 } },
                        { text: "Physics lab", ref: "you excelled in physics and electronics", score: { ec: 15, ee: 15, robot: 12 } },
                        { text: "Workshop practice", ref: "you loved working in the machine workshop", score: { mech: 15, prod: 15, auto: 12 } },
                        { text: "Drawing or design", ref: "you enjoyed design and drafting", score: { civil: 15, fashion: 12, textile: 12 } }
                    ]
                },
                {
                    text: "Your favorite type of work would be:",
                    desc: "Envision your ideal daily routine.",
                    options: [
                        { text: "Sitting with computer", ref: "you prefer an IT-focused desk job", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Working with machines", ref: "you want to be around active machinery", score: { mech: 15, auto: 15, prod: 15 } },
                        { text: "Visiting sites and projects", ref: "you like being on-site for physical projects", score: { civil: 15, env: 12, agri: 12 } },
                        { text: "Researching new ideas", ref: "you are driven by research and innovation", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "You feel strong in:",
                    desc: "Identify your core natural talent.",
                    options: [
                        { text: "Logical thinking", ref: "logic is your primary mental tool", score: { cs: 15, it: 15, math: 12 } },
                        { text: "Practical work", ref: "you're a hands-on technical worker", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Planning & structure", ref: "you're a master of organization and structure", score: { civil: 15, env: 12, agri: 12 } },
                        { text: "Analytical thinking", ref: "you excel at breaking down complex data", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "What excites you more?",
                    desc: "The type of project that ignites your passion.",
                    options: [
                        { text: "Creating an app", ref: "you're an aspiring app developer", score: { cs: 15, it: 15, ai: 10 } },
                        { text: "Fixing an engine", ref: "you're a pro at engine mechanics", score: { auto: 15, mech: 15, aero: 12 } },
                        { text: "Designing a building", ref: "you have the vision of an architect", score: { civil: 15, env: 12, agri: 10 } },
                        { text: "Building smart systems", ref: "you're building the brain of future tech", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "You prefer learning by:",
                    desc: "How do you naturally process information?",
                    options: [
                        { text: "Practicing on computer", ref: "you learn best through digital practice", score: { cs: 15, it: 15, cyber: 10 } },
                        { text: "Doing physical work", ref: "you're a hands-on physical learner", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Drawing and planning", ref: "you learn by visualizing and drafting", score: { civil: 15, fashion: 12, textile: 12 } },
                        { text: "Reading and analyzing", ref: "you're a deep analytical researcher", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "Your dream workplace:",
                    desc: "Where you see yourself in 5 years.",
                    options: [
                        { text: "IT office", ref: "you belong in a fast-paced tech firm", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Factory", ref: "the heart of industry is where you belong", score: { prod: 15, mech: 15, auto: 12 } },
                        { text: "Construction site", ref: "you want to build massive landmarks", score: { civil: 15, env: 12, architecture: 12 } },
                        { text: "Research lab", ref: "you are a pioneer of innovation labs", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "If something stops working, you:",
                    desc: "Your instinctive approach to troubleshooting.",
                    options: [
                        { text: "Debug software", ref: "you're a digital troubleshootings expert", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Open and check parts", ref: "you're a mechanical investigator", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Check structure/design", ref: "you look for foundational structural faults", score: { civil: 15, env: 12, agri: 10 } },
                        { text: "Study the system logic", ref: "you analyze system-wide patterns", score: { ai: 15, ec: 15, ee: 12 } }
                    ]
                },
                {
                    text: "You like problems that involve:",
                    desc: "The category of hurdles you enjoy clearing.",
                    options: [
                        { text: "Coding", ref: "digital coding challenges are your forte", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Machines", ref: "mechanical machine problems excite you", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Structures", ref: "building structural challenges are your pick", score: { civil: 15, env: 12, agri: 10 } },
                        { text: "Data or systems", ref: "you master complex data and system logic", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "In free time, you would:",
                    desc: "What catches your attention during leisure?",
                    options: [
                        { text: "Learn new software", ref: "you spend free time on software tech", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Watch machine videos", ref: "you're into mechanical inventions on video", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "See building designs", ref: "you're curious about architectural visuals", score: { civil: 15, env: 12, architecture: 15 } },
                        { text: "Learn about AI or smart tech", ref: "you're excited by AI and the future", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "You are more comfortable:",
                    desc: "Your characteristic work style.",
                    options: [
                        { text: "Working long time on computer", ref: "you have high digital stamina", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Working with tools", ref: "you're a wizard with heavy tools", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Working outdoors", ref: "the open air is your preferred workstation", score: { civil: 15, agri: 15, env: 12 } },
                        { text: "Doing research work", ref: "you're at home in research environments", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "What gives you satisfaction?",
                    desc: "What makes you feel truly accomplished?",
                    options: [
                        { text: "Solving logical puzzles", ref: "logical puzzles give you great pride", score: { cs: 15, it: 12, ai: 12 } },
                        { text: "Repairing equipment", ref: "you're the go-to person for repairs", score: { mech: 15, auto: 15, ee: 10 } },
                        { text: "Designing strong structures", ref: "you build structures that last eternity", score: { civil: 15, env: 12, architecture: 15 } },
                        { text: "Improving smart systems", ref: "you're a master of technological efficiency", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "Your friends say you are:",
                    desc: "How others perceive your natural role.",
                    options: [
                        { text: "Tech smart", ref: "you've earned a 'tech-smart' reputation", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Practical person", ref: "others see you as a practical fix-it person", score: { mech: 15, auto: 15, civil: 12 } },
                        { text: "Good planner", ref: "you're the designated planner in your group", score: { civil: 15, prod: 15, env: 12 } },
                        { text: "Deep thinker", ref: "people respect your deep analytical mind", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "When learning something new:",
                    desc: "How you approach a new topic.",
                    options: [
                        { text: "Try coding it", ref: "you learn through coding it yourself", score: { cs: 15, it: 15, ai: 12 } },
                        { text: "Try building it", ref: "you learn by building physical models", score: { mech: 15, auto: 15, robot: 12 } },
                        { text: "Draw and plan it", ref: "you learn by drafting it on paper", score: { civil: 15, fashion: 12, textile: 12 } },
                        { text: "Study and understand fully", ref: "you are a master of fundamental principles", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "Which place feels comfortable?",
                    desc: "Identify your ideal professional habitat.",
                    options: [
                        { text: "Software company", ref: "you belong in a high-tech software house", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Industrial area", ref: "you're comfortable in industrial production zones", score: { prod: 15, mech: 15, auto: 12 } },
                        { text: "Building project site", ref: "the site of a building project is your workspace", score: { civil: 15, env: 12, architecture: 15 } },
                        { text: "Innovation center", ref: "you thrive in centers of creative innovation", score: { ai: 15, robot: 15, aero: 12 } }
                    ]
                },
                {
                    text: "You prefer a job that:",
                    desc: "Your core work-life preference.",
                    options: [
                        { text: "Can be done remotely", ref: "you value remote and digital flexibility", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Needs physical work", ref: "you thrive on physical technical labor", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Involves field visits", ref: "you like work that takes you out into the field", score: { civil: 15, agri: 15, env: 12 } },
                        { text: "Needs research", ref: "you're a natural research and development hire", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "You enjoy:",
                    desc: "Your primary professional interest.",
                    options: [
                        { text: "Digital work", ref: "you're a digital professional at heart", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Mechanical work", ref: "you're a master of mechanical works", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Structural work", ref: "you're built for structural engineering works", score: { civil: 15, env: 12, agri: 12 } },
                        { text: "Intelligent systems", ref: "you're an architect of intelligent digital systems", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "When making decisions, you use:",
                    desc: "Identify your primary decision-making tool.",
                    options: [
                        { text: "Logic", ref: "pure logic is your guide for decisions", score: { cs: 15, it: 15, math: 12 } },
                        { text: "Real experience", ref: "you base decisions on real-world experience", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Planning", ref: "careful planning is your decision-making base", score: { civil: 15, env: 12, architecture: 15 } },
                        { text: "Data", ref: "data-driven decisions are your specialty", score: { ai: 15, chem: 15, biomed: 15 } }
                    ]
                },
                {
                    text: "You see yourself as:",
                    desc: "Your core identity as a problem solver.",
                    options: [
                        { text: "Logical person", ref: "you identify as a logical innovator", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Hands-on worker", ref: "you're essentially a hands-on mechanical worker", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Designer", ref: "you are primarily a physical designer", score: { civil: 15, fashion: 15, textile: 12 } },
                        { text: "Analyst", ref: "you are a deep system analyst", score: { ai: 15, math: 15, ec: 12 } }
                    ]
                },
                {
                    text: "If given a project, you choose:",
                    desc: "Your dream assignment.",
                    options: [
                        { text: "Build a website", ref: "website creation is your preferred project", score: { it: 15, cs: 15, cyber: 12 } },
                        { text: "Improve a machine", ref: "you'd rather spend time improving machinery", score: { mech: 15, auto: 15, prod: 15 } },
                        { text: "Plan a building", ref: "planning a building is your ideal project", score: { civil: 15, env: 12, architecture: 15 } },
                        { text: "Develop automation", ref: "you want to automate everything with AI", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "You prefer tasks that are:",
                    desc: "The nature of work you enjoy most.",
                    options: [
                        { text: "Technology based", ref: "you live at the center of technology", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Tool based", ref: "you're a master of technical tools", score: { mech: 15, auto: 12, aero: 12 } },
                        { text: "Structure based", ref: "you care about structural foundations", score: { civil: 15, architect: 12, env: 12 } },
                        { text: "Research based", ref: "you're a pioneer of research fields", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "Which achievement makes you proud?",
                    desc: "The ultimate milestone.",
                    options: [
                        { text: "Launching software", ref: "launching software products is your goal", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Designing engine", ref: "you want to design an iconic engine unit", score: { auto: 15, mech: 15, aero: 12 } },
                        { text: "Building bridge", ref: "you'd like to build a landmark bridge", score: { civil: 15, env: 12, agri: 12 } },
                        { text: "Creating smart robot", ref: "creating an intelligent robot is your aim", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "Under pressure, you:",
                    desc: "Your characteristic reaction to stress.",
                    options: [
                        { text: "Think logically", ref: "logic is your shield during pressure", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Act practically", ref: "you remain calm and act practically", score: { mech: 15, auto: 15, prod: 12 } },
                        { text: "Plan carefully", ref: "you carefully pivot with a new plan", score: { civil: 15, prod: 15, env: 12 } },
                        { text: "Analyze deeply before acting", ref: "you analyze every angle before acting", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "You are interested in:",
                    desc: "Identify your primary curiosity.",
                    options: [
                        { text: "Digital innovation", ref: "digital innovation drives your curiosity", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Mechanical systems", ref: "you are fascinated by mechanical systems", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Infrastructure", ref: "you care about the world's infrastructure", score: { civil: 15, env: 15, agri: 12 } },
                        { text: "Artificial intelligence", ref: "you're obsessed with artificial intelligence", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "You imagine future job in:",
                    desc: "Where you see your career path landing.",
                    options: [
                        { text: "IT company", ref: "you see yourself in a top IT company", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Manufacturing company", ref: "you see yourself leading manufacturing", score: { prod: 15, mech: 15, auto: 12 } },
                        { text: "Construction company", ref: "you want to lead a construction firm", score: { civil: 15, architecture: 15, env: 12 } },
                        { text: "Tech research company", ref: "you're destined for tech research", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "Which skill suits you?",
                    desc: "Identify your strongest suit.",
                    options: [
                        { text: "Coding", ref: "coding is your most natural skill", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Machine handling", ref: "you have a natural hand for machines", score: { mech: 15, auto: 15, ee: 12 } },
                        { text: "Design drawing", ref: "you're a master of structural design drawing", score: { civil: 15, architecture: 15, fashion: 12 } },
                        { text: "Data analysis", ref: "you are a master of analytical data analysis", score: { ai: 15, math: 15, it: 12 } }
                    ]
                },
                {
                    text: "You enjoy learning about:",
                    desc: "What keeps you reading and curious.",
                    options: [
                        { text: "Software updates", ref: "you're always reading software updates", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Machine parts", ref: "you're curious about mechanical parts", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Building materials", ref: "you're interested in building material science", score: { civil: 15, env: 12, architecture: 12 } },
                        { text: "Smart technology", ref: "you're fascinated by smart technologies", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                },
                {
                    text: "If a system fails, you:",
                    desc: "Your troubleshooting specialty.",
                    options: [
                        { text: "Check program", ref: "you go straight to checking the program code", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Check machine", ref: "you go straight to checking the machine parts", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Check structure", ref: "you go straight to checking the structure", score: { civil: 15, env: 12, architecture: 12 } },
                        { text: "Check logic", ref: "you go straight to checking the systemic logic", score: { ai: 15, math: 15, ec: 12 } }
                    ]
                },
                {
                    text: "You prefer:",
                    desc: "Your primary work preference.",
                    options: [
                        { text: "Computer-based work", ref: "you are a computer-based professional", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Hands-on physical work", ref: "you prefer hands-on physical labor", score: { mech: 15, auto: 15, prod: 15 } },
                        { text: "Field work", ref: "you like being in the field", score: { civil: 15, agri: 15, env: 12 } },
                        { text: "Research work", ref: "you are purely a research professional", score: { ai: 15, biomed: 15, chem: 15 } }
                    ]
                },
                {
                    text: "Which work feels natural to you?",
                    desc: "Identify your true professional home.",
                    options: [
                        { text: "Digital & software", ref: "digital and software work is your home", score: { cs: 15, it: 15, cyber: 12 } },
                        { text: "Machines & tools", ref: "machines and tools feel most natural", score: { mech: 15, auto: 15, aero: 12 } },
                        { text: "Buildings & sites", ref: "buildings and project sites are your home", score: { civil: 15, env: 15, architecture: 12 } },
                        { text: "Smart systems & analysis", ref: "smart systems and deep analysis is your world", score: { ai: 15, robot: 15, ec: 12 } }
                    ]
                }
            ];


            const relatedCoursesData = {
                cs: [
                    { key: 'it', why: 'Similar Role', desc: 'Information Technology offers almost identical career paths in software development with often slightly more accessible cutoffs.' },
                    { key: 'ai', why: 'Trending', desc: 'AI & Data Science is a specialized version of CS focusing on machine learning and big data analytics.' },
                    { key: 'ec', why: 'Hardware mix', desc: 'Electronics & Communication lets you work on both hardware design and software development.' }
                ],
                it: [
                    { key: 'cs', why: 'Core Software', desc: 'Computer Science is the broader foundation for all software and computing systems.' },
                    { key: 'ai', why: 'Data Focus', desc: 'If you enjoy the data management side of IT, AI & Data Science is a perfect next step.' },
                    { key: 'ec', why: 'Connectivity', desc: 'Network design and communication hardware are foundational to modern IT systems.' }
                ],
                ai: [
                    { key: 'cs', why: 'Foundation', desc: 'Provides the broad computing background that makes specialized AI knowledge even more powerful.' },
                    { key: 'it', why: 'Implementation', desc: 'Focuses on how to deploy and manage large scale information systems.' },
                    { key: 'ec', why: 'Robotics', desc: 'The physical brain for AI systems often lives in embedded electronic controllers.' }
                ],
                mech: [
                    { key: 'prod', why: 'Industry 4.0', desc: 'Production engineering focuses on manufacturing efficiency and modern industrial management.' },
                    { key: 'civil', why: 'Structural', desc: 'Both share foundations in mechanics and physical design across different scales.' },
                    { key: 'ee', why: 'Power/EVs', desc: 'The future of mechanical systems is increasingly electrical (EVs, Automation).' }
                ],
                civil: [
                    { key: 'mech', why: 'Mechanics', desc: 'Shares core physics principles regarding forces and material properties.' },
                    { key: 'chem', why: 'Materials', desc: 'Crucial for understanding cement, polymers, and advanced construction materials.' },
                    { key: 'ee', why: 'Smart Cities', desc: 'Electrical grids and renewable energy are the nervous system of modern urban planning.' }
                ],
                ec: [
                    { key: 'cs', why: 'Embedded', desc: 'Crucial if you want to write the software that runs on electronic hardware.' },
                    { key: 'ee', why: 'Power Electronics', desc: 'The base for working on power grids, motors, and high-voltage systems.' },
                    { key: 'it', why: 'Networking', desc: 'Electronic communication signals are the base of all Information Technology.' }
                ],
                ee: [
                    { key: 'ec', why: 'Electronics', desc: 'Focuses more on low-voltage signals, communication, and micro-processors.' },
                    { key: 'mech', why: 'Control Systems', desc: 'Perfect for working on robotics and automated machinery.' },
                    { key: 'cs', why: 'Automation', desc: 'Modern electrical grids are managed by sophisticated software and AI algorithms.' }
                ],
                chem: [
                    { key: 'bio', why: 'Life Sciences', desc: 'Biotechnology uses chemical principles to solve medical and biological challenges.' },
                    { key: 'mech', why: 'Process Plant', desc: 'Design the massive machines and systems used in chemical production.' },
                    { key: 'prod', why: 'Optimization', desc: 'Managing chemical manufacturing at scale requires deep understanding of industrial processes.' }
                ],
                bio: [
                    { key: 'chem', why: 'Molecular', desc: 'The fundamental chemistry behind biological processes and pharmaceutical design.' },
                    { key: 'it', why: 'Bioinformatics', desc: 'Big data and software are the tools used to map genomes and biological patterns.' }
                ],
                prod: [
                    { key: 'mech', why: 'Design', desc: 'Learn how to design the parts that your production lines will be manufacturing.' },
                    { key: 'it', why: 'ERP/Data', desc: 'Modern production relies heavily on data systems for logistics and supply chain.' },
                    { key: 'civil', why: 'Logistics', desc: 'Infrastructure planning is a key component of industrial and factory setup.' }
                ]
            };

            function setAcademicGroup(group) {
                currentAssessment.academic.group = group;
                document.getElementById('groupMath').classList.toggle('active', group === 'math');
                document.getElementById('groupCS').classList.toggle('active', group === 'cs');
                document.getElementById('csMarkField').style.display = group === 'cs' ? 'block' : 'none';
            }

            function updateAssessmentNav(currentScreen) {
                const nav = document.getElementById('assessmentBackNav');
                nav.style.display = currentScreen === 'academicProfile' ? 'none' : 'flex';

                // Update indicators
                const indicators = document.querySelectorAll('.step-indicator');
                const stepMap = { 'academicProfile': 0, 'goalSelection': 1, 'modeSelection': 2, 'interestQuiz': 2, 'branchSelector': 2, 'resultContainer': 3 };
                const currentStep = stepMap[currentScreen];

                indicators.forEach((ind, idx) => {
                    ind.className = 'step-indicator' + (idx < currentStep ? ' active' : '');
                    if (idx === currentStep - 1) ind.classList.add('active');
                });
            }

            function navigateToAssessmentScreen(screenId) {
                const screens = ['academicProfile', 'goalSelection', 'modeSelection', 'interestQuiz', 'branchSelector', 'resultContainer'];
                screens.forEach(s => {
                    const el = document.getElementById(s);
                    if (el) el.style.display = s === screenId ? 'block' : 'none';
                });

                if (!currentAssessment.history.includes(screenId)) {
                    currentAssessment.history.push(screenId);
                }
                updateAssessmentNav(screenId);
            }

            function handleAssessmentBack() {
                if (currentAssessment.history.length > 1) {
                    currentAssessment.history.pop(); // Remove current
                    const prevScreen = currentAssessment.history[currentAssessment.history.length - 1];

                    // Specific cleanup if going back from results
                    if (prevScreen === 'modeSelection' && currentAssessment.mode === 'goal') {
                        // If we are in goal mode, modeSelection isn't really "back", goalSelection is.
                        handleAssessmentBack(); // Go back one more
                        return;
                    }

                    navigateToAssessmentScreen(prevScreen);
                }
            }

            function proceedToGoalSelection() {
                // Capture marks
                currentAssessment.academic.marks = {
                    math: parseInt(document.getElementById('markMath').value) || 0,
                    physics: parseInt(document.getElementById('markPhysics').value) || 0,
                    chem: parseInt(document.getElementById('markChem').value) || 0,
                    cs: parseInt(document.getElementById('markCS').value) || 0,
                    overall: parseInt(document.getElementById('markOverall').value) || 0
                };

                // Validate basic marks
                if (!currentAssessment.academic.marks.math || !currentAssessment.academic.marks.physics) {
                    alert("Please enter at least Mathematics and Physics marks.");
                    return;
                }

                renderGoalSelection();
                navigateToAssessmentScreen('goalSelection');
            }

            function renderGoalSelection() {
                const grid = document.getElementById('goalGrid');
                grid.innerHTML = '';

                for (let key in branchMapping) {
                    const item = document.createElement('div');
                    item.className = 'goal-item';
                    item.innerHTML = `
                        <div class="goal-item-icon" > ${getGoalIcon(key)}</div>
                            <div class="goal-item-name">${branchMapping[key].name}</div>
                    `;
                    item.onclick = () => selectGoal(key);
                    grid.appendChild(item);
                }
            }

            function getGoalIcon(key) {
                const icons = {
                    cs: 'ðŸ’»', it: 'ðŸŒ', ai: 'ðŸ¤–', ec: 'ðŸ“¡', ee: 'âš¡', mech: 'âš™ï¸', civil: 'ðŸ—ï¸', chem: 'ðŸ§ª',
                    cyber: 'ðŸ›¡ï¸', agri: 'ðŸšœ', robot: 'ðŸ¦¾', aero: 'ðŸš€', biomed: 'ðŸ©º', fashion: 'ðŸ‘—',
                    textile: 'ðŸ§µ', food: 'ðŸ•', petro: 'ðŸ›¢ï¸', auto: 'ðŸŽï¸', env: 'ðŸŒ', prod: 'ðŸ­'
                };
                return icons[key] || 'ðŸŽ“';
            }


            function selectGoal(key) {
                currentAssessment.goal = key;
                currentAssessment.mode = 'goal';
                showAssessmentResults();

                // Fix: Scroll to top so user sees the updated guidance
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Also show the detailed modal for that specific branch
                const branch = branchMapping[key];
                if (branch) {
                    showCourseDetails(branch.name);
                }
            }

            function proceedToModeSelection() {
                currentAssessment.goal = null;
                navigateToAssessmentScreen('modeSelection');
            }

            function selectAssessmentMode(mode) {
                currentAssessment.mode = mode;
                if (mode === 'comparison') {
                    showBranchSelector();
                } else if (mode === 'discovery') {
                    startInterestQuiz();
                } else {
                    showAssessmentResults();
                }
            }

            function startInterestQuiz() {
                currentAssessment.quizIndex = 0;
                currentAssessment.quizScores = {};
                currentAssessment.quizRef = [];
                for (let k in branchMapping) currentAssessment.quizScores[k] = 0;
                renderInterestQuiz();
                navigateToAssessmentScreen('interestQuiz');
            }

            function renderInterestQuiz() {
                const q = assessmentQuestions[currentAssessment.quizIndex];
                const total = assessmentQuestions.length;
                const progress = ((currentAssessment.quizIndex) / total) * 100;

                document.getElementById('quizStepText').innerText = `Question ${currentAssessment.quizIndex + 1} of ${total}`;
                document.getElementById('quizPercentText').innerText = `${Math.round(progress)}% Complete`;
                document.getElementById('quizProgressBar').style.width = `${progress}%`;
                document.getElementById('quizQuestion').innerText = q.text;
                document.getElementById('quizDesc').innerText = q.desc;

                const optionsCont = document.getElementById('quizOptions');
                optionsCont.innerHTML = '';

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'quiz-option';
                    btn.innerHTML = `
                        <h5>${opt.text}</h5>
                        <p>Select this if it's most like you</p>
                    `;
                    btn.onclick = () => selectQuizOption(idx);
                    optionsCont.appendChild(btn);
                });
            }

            function selectQuizOption(idx) {
                const q = assessmentQuestions[currentAssessment.quizIndex];
                const opt = q.options[idx];

                // Accumulate scores
                for (let k in opt.score) {
                    if (currentAssessment.quizScores[k] !== undefined) {
                        currentAssessment.quizScores[k] += opt.score[k];
                    }
                }

                // Store preference for result personalization
                if (opt.ref) currentAssessment.quizRef.push(opt.ref);

                currentAssessment.quizIndex++;

                if (currentAssessment.quizIndex < assessmentQuestions.length) {
                    renderInterestQuiz();
                } else {
                    // Quiz finished!
                    document.getElementById('quizProgressBar').style.width = `100%`;
                    document.getElementById('quizPercentText').innerText = `100% Complete`;
                    setTimeout(() => {
                        showAssessmentResults();
                    }, 500);
                }
            }

            function showBranchSelector() {
                const cont = document.getElementById('comparisonBranchChips');
                cont.innerHTML = '';

                for (let key in branchMapping) {
                    const chip = document.createElement('div');
                    chip.className = 'branch-chip-input';
                    chip.innerText = branchMapping[key].name;
                    chip.onclick = () => toggleComparisonBranch(key, chip);
                    cont.appendChild(chip);
                }

                updateStartComparisonBtn();
                navigateToAssessmentScreen('branchSelector');
            }

            function toggleComparisonBranch(key, el) {
                const idx = currentAssessment.selectedCompareBranches.indexOf(key);
                if (idx >= 0) {
                    currentAssessment.selectedCompareBranches.splice(idx, 1);
                    el.classList.remove('selected');
                } else {
                    if (currentAssessment.selectedCompareBranches.length < 3) {
                        currentAssessment.selectedCompareBranches.push(key);
                        el.classList.add('selected');
                    } else {
                        alert("Please select up to 3 branches for comparison.");
                    }
                }
                updateStartComparisonBtn();
            }

            function updateStartComparisonBtn() {
                const btn = document.getElementById('startComparisonBtn');
                const count = currentAssessment.selectedCompareBranches.length;
                btn.disabled = count < 2;
                btn.innerText = count < 2 ? 'Select at least 2 branches' : 'Show Comparison Guidance';
            }

            function backToModeSelection() {
                currentAssessment.selectedCompareBranches = [];
                navigateToAssessmentScreen('modeSelection');
            }

            function toggleDetailCard(element) {
                const panel = element.querySelector('.detailed-info-panel');
                const isVisible = panel.style.display === 'block';

                // Close all other panels first
                document.querySelectorAll('.detailed-info-panel').forEach(p => p.style.display = 'none');

                if (!isVisible) {
                    panel.style.display = 'block';
                }
            }

            function showAssessmentResults() {
                navigateToAssessmentScreen('resultContainer');

                const marks = currentAssessment.academic.marks;
                const mode = currentAssessment.mode;
                const goal = currentAssessment.goal;

                // TNEA Cutoff Calculation: Math + Phys/2 + Chem/2 (Total 200)
                const userCutoff = marks.math + (marks.physics / 2) + (marks.chem / 2);

                const scores = {};
                for (let k in branchMapping) scores[k] = 0;

                // Software/Digital
                scores.cs += marks.math * 0.4 + marks.cs * 0.6;
                scores.ai += marks.math * 0.6 + marks.cs * 0.4;
                scores.it += marks.math * 0.3 + marks.cs * 0.7;
                scores.cyber += marks.math * 0.5 + marks.cs * 0.5;

                // Hardware/Signals
                scores.ec += marks.math * 0.5 + marks.physics * 0.5;
                scores.ee += marks.math * 0.4 + marks.physics * 0.6;

                // Design/Build
                scores.mech += marks.physics * 0.7 + marks.math * 0.3;
                scores.civil += marks.physics * 0.6 + marks.math * 0.4;
                scores.auto += marks.physics * 0.8 + marks.math * 0.2;
                scores.aero += marks.math * 0.8 + marks.physics * 0.2;
                scores.robot += marks.math * 0.6 + marks.physics * 0.4;

                // Process/Bio
                scores.chem += marks.chem * 0.8 + marks.math * 0.2;
                scores.food += marks.chem * 0.7 + marks.math * 0.3;
                scores.petro += marks.chem * 0.6 + marks.math * 0.4;
                scores.biomed += marks.chem * 0.5 + marks.physics * 0.5;
                scores.agri += marks.math * 0.4 + (marks.physics + marks.chem) / 4;

                // Production/Materials
                scores.prod += marks.math * 0.5 + marks.physics * 0.5;
                scores.fashion += marks.math * 0.3 + marks.physics * 0.3 + 40;
                scores.textile += marks.math * 0.3 + marks.physics * 0.3 + 40;
                scores.env += marks.chem * 0.4 + marks.physics * 0.4 + marks.math * 0.2;

                // Add Interest Scores (Weighted integration)
                if (mode === 'discovery' && currentAssessment.quizScores) {
                    for (let k in currentAssessment.quizScores) {
                        if (scores[k] !== undefined) {
                            // Boost existing scores with interest data
                            scores[k] = (scores[k] * 0.6) + (currentAssessment.quizScores[k] * 0.4);
                        } else {
                            scores[k] = currentAssessment.quizScores[k] * 0.4;
                        }
                    }
                }

                let bestKey = goal || 'cs';
                if (!goal) {
                    let maxScore = -1;
                    if (mode === 'comparison') {
                        currentAssessment.selectedCompareBranches.forEach(key => {
                            if (scores[key] > maxScore) { maxScore = scores[key]; bestKey = key; }
                        });
                    } else {
                        for (let key in scores) {
                            if (scores[key] > maxScore) { maxScore = scores[key]; bestKey = key; }
                        }
                    }
                }

                const rec = branchMapping[bestKey] || branchMapping.cs;
                const isRecFav = isBranchFavorite(rec.name);
                document.getElementById('resultBranch').innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center; gap:1rem;">
                        <span>${goal ? `Goal Analysis: ${rec.name}` : rec.name}</span>
                        <button class="btn-icon ${isRecFav ? 'saved' : ''}" 
                                onclick="toggleBranchFavorite('${rec.name}', this)" 
                                title="Favorite this course"
                                style="font-size: 1.5rem; background: none; border: none; cursor: pointer;">
                            ${isRecFav ? 'â¤ï¸' : 'ðŸ¤'}
                        </button>
                    </div>
                `;


                const topSubject = Object.entries({ Math: marks.math, Physics: marks.physics, Chemistry: marks.chem, CS: marks.cs })
                    .sort((a, b) => b[1] - a[1])[0][0];

                // --- PERSONA BASED ENHANCEMENT ---
                const userName = authState.user ? (authState.user.name || authState.user.username) : "Student";
                const resultDesc = document.getElementById('resultDesc');

                // Construct a personalized advisor message
                let personaMsg = "";
                if (currentAssessment.quizRef.length > 0) {
                    const sampleRefs = currentAssessment.quizRef.slice(0, 3);
                    personaMsg = `Given that ${sampleRefs.join(', and ')}, `;
                }

                resultDesc.innerHTML = `
                        <div class="advisor-card" >
                        <div class="advisor-avatar-container">
                            <div class="advisor-avatar">ðŸ‘©â€ðŸ«</div>
                        </div>
                        <div class="advisor-content">
                            <h4>Career Guidance Advisor</h4>
                            <div class="advisor-greeting">"Hello, ${userName}! I've analyzed your path..."</div>
                            <p class="advisor-text">
                                ${personaMsg} I strongly recommend the <strong>${rec.name}</strong> path for you.
                                ${goal ? `It's a perfect alignment with your stated interest.` :
                        `Based on our analysis, this field best matches your unique profile of skills and passions.`}
                            </p>
                        </div>
                    </div>

                    <div class="course-detail-grid">
                        <div class="detail-card" onclick="toggleDetailCard(this)">
                            <h5><span class="detail-icon">ðŸ”­</span> The Future</h5>
                            <p class="detail-text">${rec.future}</p>
                            <div class="detailed-info-panel">
                                <strong>What to expect:</strong> ${rec.future} This field is growing fast. Simplest way to think about it: You'll be building the things people use every day.
                            </div>
                        </div>
                        <div class="detail-card" onclick="toggleDetailCard(this)">
                            <h5><span class="detail-icon">ðŸ’¼</span> Career Path</h5>
                            <p class="detail-text">${rec.career}</p>
                            <div class="detailed-info-panel">
                                <strong>Growth:</strong> You usually start as a junior engineer, then become a senior/lead in 3-5 years. The more you learn, the higher you go!
                            </div>
                        </div>
                        <div class="detail-card" onclick="toggleDetailCard(this)">
                            <h5><span class="detail-icon">ðŸŽ¯</span> Why You?</h5>
                            <p class="detail-text">${rec.suitability}</p>
                            <div class="detailed-info-panel">
                                <strong>Your Match:</strong> Since you did well in ${topSubject}, you have the right mindset for this. It plays to your strengths!
                            </div>
                        </div>
                    </div>

                    <div class="balance-section">
                        <h4 style="color:var(--primary); margin-bottom:0.5rem; display:flex; align-items:center; gap:0.75rem;">
                            <span style="font-size:1.5rem;">âš–ï¸</span> Why this path? (Pros & Cons)
                        </h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem;">Every choice has trade-offs. Here is a balanced view of ${rec.name}.</p>
                        
                        <div class="balance-grid">
                            <div class="balance-column">
                                <h6 class="pros-title"><span>ðŸŒŸ</span> Positive Aspects</h6>
                                <ul class="balance-list pros-list">
                                    ${(rec.pros || []).map(p => `<li>${p}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="balance-column">
                                <h6 class="cons-title"><span>âš ï¸</span> Potential Challenges</h6>
                                <ul class="balance-list cons-list">
                                    ${(rec.cons || []).map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    `;

                // Breakdown for Comparison
                if (mode === 'comparison') {
                    // ... (keep breakdown logic)
                    document.getElementById('comparisonBreakdown').style.display = 'block';
                    const list = document.getElementById('breakdownList');
                    list.innerHTML = '';
                    const sortedCompare = [...currentAssessment.selectedCompareBranches].sort((a, b) => scores[b] - scores[a]);
                    const totalSelectedScore = sortedCompare.reduce((sum, k) => sum + (scores[k] || 0), 0) || 1;

                    sortedCompare.forEach(key => {
                        const score = scores[key];
                        const percentage = Math.round((score / totalSelectedScore) * 100);
                        const item = document.createElement('div');
                        item.className = 'breakdown-item';
                        item.innerHTML = `
                        <div class="breakdown-header" >
                                <span class="breakdown-label">${branchMapping[key].name}</span>
                                <span class="breakdown-percentage">${percentage}% Alignment</span>
                            </div>
                        <div class="breakdown-bar-bg">
                            <div class="breakdown-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                        list.appendChild(item);
                    });
                } else {
                    document.getElementById('comparisonBreakdown').style.display = 'none';
                }


                // 2. Improvement Tips
                const tipsList = document.getElementById('improvementTipsList');
                tipsList.innerHTML = '';
                const tips = generateImprovementTips(userCutoff, topSubject, bestKey);
                tips.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'tip-item';
                    div.innerHTML = `<span class="tip-bullet" >â€¢</span> <span>${t}</span>`;
                    tipsList.appendChild(div);
                });

                // 3. Related Courses - Personalized Tone
                const relatedCont = document.getElementById('relatedCoursesList');
                relatedCont.innerHTML = '';
                const related = relatedCoursesData[bestKey] || [];
                related.forEach(rel => {
                    const course = branchMapping[rel.key];
                    if (!course) return;
                    const isCourseFav = isBranchFavorite(course.name);
                    const card = document.createElement('div');
                    card.className = 'related-course-card';
                    card.innerHTML = `
                        <div class="related-course-header" >
                            <span class="related-course-name">${course.name}</span>
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <span class="related-why-tag">${rel.why}</span>
                                <button class="btn-icon ${isCourseFav ? 'saved' : ''}" 
                                        onclick="event.stopPropagation(); toggleBranchFavorite('${course.name}', this)" 
                                        style="background:none; border:none; cursor:pointer; font-size:1.2rem; padding:0;">
                                    ${isCourseFav ? 'â¤ï¸' : 'ðŸ¤'}
                                </button>
                            </div>
                        </div>
                        <p class="related-desc" style="font-style: italic; color: #475569; margin-bottom: 1rem;">"${rel.desc}"</p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;"><strong>In simple words:</strong> This is like ${rec.name}'s cousin. ${course.desc}</p>
                        <button class="btn-icon" onclick="selectGoal('${rel.key}')">View Guidance</button>
                    `;
                    relatedCont.appendChild(card);
                });

                const exploreBtn = document.getElementById('exploreRecommended');
                exploreBtn.onclick = () => {
                    switchTab('courses');
                    document.getElementById('courseSearch').value = rec.name;
                    renderCourseInsights();
                };
            }

            function generateImprovementTips(cutoff, topSubject, targetBranch) {
                const tips = [];
                const isTopTier = cutoff > 190;

                if (isTopTier) {
                    tips.push("Your current cutoff is excellent! You are likely to get top colleges like CEG or MIT.");
                    tips.push("Focus on maintaining consistency and preparing for counselling procedures.");
                } else if (cutoff > 175) {
                    tips.push(`Your cutoff(${cutoff.toFixed(2)}) is good.To reach top - tier colleges for ${branchMapping[targetBranch].name}, aim for 190 + marks.`);
                    tips.push(`Strengthen your ${topSubject === 'Math' ? 'Physics' : 'Math'} to boost your composite score significantly.`);
                } else {
                    tips.push(`A cutoff of ${cutoff.toFixed(2)} means you should focus on medium - tier private colleges or university regional campuses.`);
                    tips.push("Intensive practice in Mathematics is recommended as it has 50% weightage in TNEA calculation.");
                }

                if (topSubject !== 'Math') {
                    tips.push("Pro-tip: Since Math is 100% weightage while Physics/Chemistry are 50% each, improving Math by 1 mark equals improving P+C by 2 marks!");
                }

                return tips;
            }

            function startAssessment() {
                currentAssessment.history = [];
                currentAssessment.selectedCompareBranches = [];
                currentAssessment.goal = null;
                navigateToAssessmentScreen('academicProfile');
            }

            function initApp() {
                initAuth();
                loadData();
                updateFavBadge();
            }

            window.addEventListener('load', initApp);

        </script>
</body>

</html>